{% extends "base.html" %}

{% block title %}股票 - 量化交易系统{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1>
            <i class="fas fa-list"></i> 股票列表
        </h1>
        <hr>
    </div>
</div>

<div class="row mb-1">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-search"></i> 股票查询
                </h5>
                <div class="d-flex align-items-center">
                    <label for="stock-search" class="form-label me-2 mb-0">输入股票代码、名称或拼音缩写</label>
                    <input type="text" class="form-control form-control-sm me-2" id="stock-search" placeholder="例如：000001 或 平安银行 或 PAYH" style="width: 300px;">
                    <button class="btn btn-primary" id="search-stock">
                        <i class="fas fa-search"></i> 查询
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5>
                    <i class="fas fa-table"></i> 最新选股结果
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="pool-stocks-table">
                        <thead>
                            <tr>
                                <th>代码</th>
                                <th>名称</th>
                                <th>当前价格</th>
                                <th>涨跌幅</th>
                                <th>换手率</th>
                                <th>Action</th>
                                <th>Counts</th>
                                <th>Score_Calc</th>
                                <th>Score_AI</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="pool-stocks-body">
                            <!-- Data will be loaded dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Function to load latest pool stocks data
    function loadLatestPoolStocks() {
        fetch('/api/latest-pool-stocks')
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById('pool-stocks-body');
                tbody.innerHTML = '';

                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="10" class="text-center">暂无数据</td></tr>';
                    return;
                }

                data.forEach(stock => {
                    // Extract signals data - this is the actual signals field from the database
                    const signals = stock.signals || {};

                    // Initialize variables to store values
                    let action = '';
                    let counts = 0;
                    let score_calc = 0;
                    let score_ai = 0;

                    // Extract values directly from the specific strategy
                    // The structure is: signals."信号生成V1".各项值
                    const strategyName = "信号生成V1";
                    if (signals[strategyName]) {
                        const strategyData = signals[strategyName];

                        // Extract the specific values as requested
                        action = strategyData.action || '';
                        counts = strategyData.counts !== undefined ? Math.floor(strategyData.counts) : 0;
                        score_calc = strategyData.score_calc !== undefined ? strategyData.score_calc : 0;
                        score_ai = strategyData.score_ai !== undefined ? strategyData.score_ai : 0;
                    }

                    // Format change percentage with % symbol and color coding
                    let changePercentDisplay = '';
                    if (stock.change_percent !== undefined && stock.change_percent !== null) {
                        const changePercent = parseFloat(stock.change_percent);
                        const formattedChange = changePercent.toFixed(2);
                        const sign = changePercent >= 0 ? '+' : '';
                        const colorClass = changePercent >= 0 ? 'text-success' : 'text-danger';
                        changePercentDisplay = `<span class="${colorClass}">${sign}${formattedChange}%</span>`;
                    }

                    // Format turnover rate with % symbol
                    let turnoverRateDisplay = '';
                    if (stock.turnover_rate !== undefined && stock.turnover_rate !== null) {
                        const turnoverRate = parseFloat(stock.turnover_rate);
                        turnoverRateDisplay = `${turnoverRate.toFixed(2)}%`;
                    }

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${stock.code}</td>
                        <td>${stock.name || ''}</td>
                        <td>${stock.price.toFixed(2)}</td>
                        <td>${changePercentDisplay}</td>
                        <td>${turnoverRateDisplay}</td>
                        <td>${action}</td>
                        <td>${counts}</td>
                        <td>${score_calc.toFixed(2)}</td>
                        <td>${score_ai.toFixed(2)}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-success buy-btn" data-code="${stock.code}" data-name="${stock.name || stock.code}" data-price="${stock.price.toFixed(2)}">买入</button>
                        </td>
                    `;
                    // Add double-click event to open K-line chart
                    row.addEventListener('dblclick', function() {
                        window.open(`/stock-kline?code=${stock.code}&name=${encodeURIComponent(stock.name || stock.code)}`, '_blank');
                    });
                    tbody.appendChild(row);
                });
            })
            .catch(error => {
                console.error('Error loading pool stocks:', error);
                const tbody = document.getElementById('pool-stocks-body');
                tbody.innerHTML = '<tr><td colspan="10" class="text-center text-danger">加载数据失败</td></tr>';
            });
    }

            // Search functionality
            document.getElementById('search-stock').addEventListener('click', function() {
                const searchTerm = document.getElementById('stock-search').value.trim();
                if (!searchTerm) {
                    alert('请输入股票代码、名称或拼音缩写');
                    return;
                }

                searchStocks(searchTerm);
            });

            // Handle Enter key in search input
            document.getElementById('stock-search').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('search-stock').click();
                }
            });

            // Function to search stocks
            function searchStocks(searchTerm) {
                fetch('/api/stock-search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ search_term: searchTerm })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        displaySearchResults(data.results, searchTerm);
                    } else {
                        alert('搜索失败: ' + (data.error || '未知错误'));
                    }
                })
                .catch(error => {
                    console.error('Error searching stocks:', error);
                    alert('搜索失败，请稍后重试');
                });
            }

            // Function to display search results
            function displaySearchResults(results, searchTerm) {
                const tbody = document.getElementById('pool-stocks-body');

                if (results.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="10" class="text-center">未找到与 "${searchTerm}" 相关的股票</td></tr>`;
                    return;
                }

                tbody.innerHTML = '';

                results.forEach(stock => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${stock.code}</td>
                        <td>${stock.name || ''}</td>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                        <td>
                            <button class="btn btn-sm btn-outline-success buy-btn" data-code="${stock.code}" data-name="${stock.name || stock.code}" data-price="0">买入</button>
                        </td>
                    `;
                    // Add double-click event to open K-line chart
                    row.addEventListener('dblclick', function() {
                        window.open(`/stock-kline?code=${stock.code}&name=${encodeURIComponent(stock.name || stock.code)}`, '_blank');
                    });
                    tbody.appendChild(row);
                });
            }
    
    // Load data when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadLatestPoolStocks();

        // Buy modal functionality
        let currentStockCode = '';
        let currentStockName = '';
        let currentStockPrice = 0;

        // Handle buy button clicks using event delegation
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('buy-btn')) {
                const button = e.target;
                currentStockCode = button.getAttribute('data-code');
                currentStockName = button.getAttribute('data-name');
                currentStockPrice = parseFloat(button.getAttribute('data-price'));

                // Set default date to today
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('buyDate').value = today;

                // Set stock code and name directly from data attributes
                document.getElementById('stockCode').value = currentStockCode;
                document.getElementById('stockName').value = currentStockName;

                // Set stock price
                document.getElementById('buyPrice').value = currentStockPrice.toFixed(2);

                // Load accounts
                loadAccountsForBuy();

                // Show modal using Bootstrap's JavaScript API
                const buyModal = new bootstrap.Modal(document.getElementById('buyModal'));
                buyModal.show();
            }
        });

        // Load accounts for buy modal
        function loadAccountsForBuy() {
            fetch('/api/accounts')
                .then(response => response.json())
                .then(accounts => {
                    const accountSelect = document.getElementById('accountSelect');
                    accountSelect.innerHTML = '<option value="">请选择账户</option>';
                    accounts.forEach(function(account) {
                        const option = document.createElement('option');
                        option.value = account._id;
                        option.textContent = account.name;
                        accountSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Failed to load accounts:', error);
                });
        }

        // Handle stock code input change
        document.getElementById('stockCode').addEventListener('input', function() {
            const code = this.value;
            if (code) {
                // In a real implementation, you would fetch the stock name from the server
                // For now, we'll just leave it as is since we're getting it from the data attributes
            } else {
                document.getElementById('stockName').value = '';
            }
        });

        // Handle buy form submission
        document.getElementById('buyForm').addEventListener('submit', function(e) {
            e.preventDefault();

            // Get selected account name
            const accountSelect = document.getElementById('accountSelect');
            const selectedOption = accountSelect.options[accountSelect.selectedIndex];
            const accountName = selectedOption.textContent;

            const orderData = {
                date: document.getElementById('buyDate').value,
                account_id: document.getElementById('accountSelect').value,
                account_name: accountName,  // Add account name to order data
                code: document.getElementById('stockCode').value,
                name: document.getElementById('stockName').value,
                price: parseFloat(document.getElementById('buyPrice').value),
                quantity: parseInt(document.getElementById('buyQuantity').value)
            };

            // Validate form
            if (!orderData.date || !orderData.account_id || !orderData.code || !orderData.name || !orderData.price || !orderData.quantity) {
                alert('请填写所有必填字段');
                return;
            }

            // Save order to database
            fetch('/api/orders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(orderData)
            })
            .then(response => response.json())
            .then(response => {
                if (response.status === 'success') {
                    alert('订单创建成功');
                    // Hide modal using Bootstrap's JavaScript API
                    const buyModalElement = document.getElementById('buyModal');
                    const buyModal = bootstrap.Modal.getInstance(buyModalElement);
                    if (buyModal) {
                        buyModal.hide();
                    } else {
                        // If instance doesn't exist, create new one and hide
                        const modal = new bootstrap.Modal(buyModalElement);
                        modal.hide();
                    }
                    // Reset form
                    document.getElementById('buyForm').reset();
                } else {
                    alert('订单创建失败: ' + response.message);
                }
            })
            .catch(error => {
                alert('订单创建失败: ' + error.message);
                console.error('Order creation error:', error);
            });
        });

        // Handle confirm button click
        document.getElementById('confirmBuy').addEventListener('click', function() {
            document.getElementById('buyForm').dispatchEvent(new Event('submit'));
        });
    });
</script>

<!-- Buy Modal -->
<div class="modal fade" id="buyModal" tabindex="-1" aria-labelledby="buyModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="buyModalLabel">买入股票</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="buyForm">
                    <div class="mb-3">
                        <label for="buyDate" class="form-label">日期</label>
                        <input type="date" class="form-control" id="buyDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="accountSelect" class="form-label">账户</label>
                        <select class="form-select" id="accountSelect" required>
                            <option value="">请选择账户</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="stockCode" class="form-label">股票代码</label>
                        <input type="text" class="form-control" id="stockCode" required>
                    </div>
                    <div class="mb-3">
                        <label for="stockName" class="form-label">股票名称</label>
                        <input type="text" class="form-control" id="stockName" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="buyPrice" class="form-label">买入价格</label>
                        <input type="number" class="form-control" id="buyPrice" step="0.01" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label for="buyQuantity" class="form-label">买入数量</label>
                        <input type="number" class="form-control" id="buyQuantity" min="1" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirmBuy">确认</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

