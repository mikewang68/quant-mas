{% extends "base.html" %}

{% block title %}股票 - 量化交易系统{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1>
            <i class="fas fa-list"></i> 股票列表
        </h1>
        <hr>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5>
                    <i class="fas fa-filter"></i> 筛选条件
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label for="sector-filter" class="form-label">行业</label>
                        <select class="form-select" id="sector-filter">
                            <option value="">全部行业</option>
                            <option value="banking">银行</option>
                            <option value="technology">科技</option>
                            <option value="manufacturing">制造业</option>
                            <option value="energy">能源</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="market-filter" class="form-label">市场</label>
                        <select class="form-select" id="market-filter">
                            <option value="">全部市场</option>
                            <option value="sh">上海证券交易所</option>
                            <option value="sz">深圳证券交易所</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="sort-by" class="form-label">排序</label>
                        <select class="form-select" id="sort-by">
                            <option value="code">代码</option>
                            <option value="name">名称</option>
                            <option value="price">价格</option>
                            <option value="change">涨跌幅</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3 d-flex align-items-end">
                        <button class="btn btn-primary w-100" id="apply-filter">
                            <i class="fas fa-search"></i> 应用筛选
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5>
                    <i class="fas fa-table"></i> 最新选股结果
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="pool-stocks-table">
                        <thead>
                            <tr>
                                <th>代码</th>
                                <th>名称</th>
                                <th>当前价格</th>
                                <th>涨跌幅</th>
                                <th>换手率</th>
                                <th>Action</th>
                                <th>Counts</th>
                                <th>Score_Calc</th>
                                <th>Score_AI</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="pool-stocks-body">
                            <!-- Data will be loaded dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Function to load latest pool stocks data
    function loadLatestPoolStocks() {
        fetch('/api/latest-pool-stocks')
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById('pool-stocks-body');
                tbody.innerHTML = '';

                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan=\"10\" class=\"text-center\">暂无数据</td></tr>';
                    return;
                }

                data.forEach(stock => {
                    // Extract signals data - this is the actual signals field from the database
                    const signals = stock.signal || {};

                    // Initialize variables to store values
                    let action = '';
                    let counts = 0;
                    let score_calc = 0;
                    let score_ai = 0;

                    // Extract values directly from the specific strategy
                    // The structure is: signals."信号生成V1".各项值
                    const strategyName = "信号生成V1";
                    if (signals[strategyName]) {
                        const strategyData = signals[strategyName];

                        // Extract the specific values as requested
                        action = strategyData.action || '';
                        counts = strategyData.counts !== undefined ? Math.floor(strategyData.counts) : 0;
                        score_calc = strategyData.score_calc !== undefined ? strategyData.score_calc : 0;
                        score_ai = strategyData.score_ai !== undefined ? strategyData.score_ai : 0;
                    }

                        // Format change percentage with % symbol and color coding
                        let changePercentDisplay = '';
                        if (stock.change_percent !== undefined && stock.change_percent !== null) {
                            const changePercent = parseFloat(stock.change_percent);
                            const formattedChange = changePercent.toFixed(2);
                            const sign = changePercent >= 0 ? '+' : '';
                            const colorClass = changePercent >= 0 ? 'text-success' : 'text-danger';
                            changePercentDisplay = `<span class="${colorClass}">${sign}${formattedChange}%</span>`;
                        }
    
                        // Format turnover rate with % symbol
                        let turnoverRateDisplay = '';
                        if (stock.turnover_rate !== undefined && stock.turnover_rate !== null) {
                            const turnoverRate = parseFloat(stock.turnover_rate);
                            turnoverRateDisplay = `${turnoverRate.toFixed(2)}%`;
                        }
    
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${stock.code}</td>
                            <td>${stock.name || ''}</td>
                            <td>${stock.price.toFixed(2)}</td>
                            <td>${changePercentDisplay}</td>
                            <td>${turnoverRateDisplay}</td>
                        <td>${action}</td>
                        <td>${counts}</td>
                        <td>${score_calc.toFixed(2)}</td>
                        <td>${score_ai.toFixed(2)}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary">详情</button>
                        </td>
                    `;
                    // Add double-click event to open K-line chart
                    row.addEventListener('dblclick', function() {
                        window.open(`/stock-kline?code=${stock.code}&name=${encodeURIComponent(stock.name || stock.code)}`, '_blank');
                    });
                    tbody.appendChild(row);
                });
            })
            .catch(error => {
                console.error('Error loading pool stocks:', error);
                const tbody = document.getElementById('pool-stocks-body');
                tbody.innerHTML = '<tr><td colspan=\"10\" class=\"text-center text-danger\">加载数据失败</td></tr>';
            });
    }

    // Load data when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadLatestPoolStocks();
    });
</script>
{% endblock %}

