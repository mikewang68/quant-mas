{% extends "base.html" %}

{% block title %}股票K线图V2 - 量化交易系统{% endblock %}

{% block content %}
<style>
    html, body {
        height: 100%;
        overflow: auto;
        margin: 0;
        padding: 0;
    }

    .main-container {
        height: 89.3vh;
        margin: 1px 5px 0 5px;
        display: flex;
        flex-direction: row;
        gap: 2px;
    }

    .panel {
        display: flex;
        flex-direction: column;
        background: #2d2d4d;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        overflow: hidden;
    }

    .left-panel {
        flex: 1;
    }

    .right-panel {
        flex: 1;
    }

    .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 2px 4px;
        background: #3a3a5a;
        border-bottom: 1px solid #444;
        min-height: 20px;
    }

    .stock-info {
        font-size: 1.2rem;
        font-weight: bold;
        color: #e0e0e0;
    }

    .panel {
        display: flex;
        flex-direction: column;
        background: #2d2d4a;
        border-radius: 0;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .btn-group-custom {
        display: flex;
        gap: 8px;
    }

    .btn-custom {
        padding: 6px 12px;
        font-size: 0.9rem;
    }

    .chart-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 0;
        margin: 0;
        min-height: 0;
    }

    .unified-chart-area {
        flex: 1;
        min-height: 0;
        margin-bottom: 0;
        display: block;
        background: transparent;
    }

    .indicator-tabs {
        margin: 0;
        padding: 0;
    }

    .nav-tabs {
        border-bottom: 1px solid #444;
        margin-bottom: 0;
    }

    .nav-tabs .nav-link {
        padding: 2px 8px;
        font-size: 0.8rem;
        border: 1px solid #444;
        border-bottom: none;
        color: #bbb;
        border-top-left-radius: 2px;
        border-top-right-radius: 2px;
    }

    .nav-tabs .nav-link.active {
        background-color: #3a3a5a;
        color: #fff;
        border-color: #555 #555 #3a3a5a;
    }

    .nav-tabs .nav-link:hover {
        background-color: #33334d;
        border-color: #555 #555 #444;
    }

    .nav-tabs .nav-link.active {
        color: #fff;
        background-color: #444466;
        border-color: #444;
        border-bottom: 1px solid #444466;
    }

    .info-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 2px;
        overflow: auto;
    }

    .tabs-container {
        margin-bottom: 0;
    }

    .tab-content {
        flex: 1;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .tab-pane {
        flex: 1;
        overflow: auto;
        display: none;
    }

    .tab-pane.active {
        display: block;
    }

    .json-display {
        flex: 1;
        background-color: #1e1e2e;
        padding: 2px;
        border-radius: 2px;
        color: #e0e0e0;
        font-family: 'Courier New', monospace;
        font-size: 0.85rem;
        overflow: auto;
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    .formatted-display {
        flex: 1;
        overflow: auto;
    }

    .strategy-section {
        margin-bottom: 15px;
        padding: 12px;
        background-color: #3a3a5a;
        border-radius: 5px;
    }

    .strategy-header {
        font-weight: bold;
        margin-bottom: 10px;
        color: #4fc3f7;
        border-bottom: 1px solid #444;
        padding-bottom: 5px;
    }

    .strategy-item {
        margin-bottom: 12px;
        padding: 10px;
        background-color: #444466;
        border-radius: 4px;
    }

    .strategy-name {
        font-weight: bold;
        color: #81d4fa;
        margin-bottom: 6px;
    }

    .strategy-score {
        color: #a5d6a7;
        font-size: 0.9rem;
    }

    .strategy-value {
        font-size: 0.85rem;
        color: #e0e0e0;
        margin-top: 6px;
        white-space: pre-wrap;
        line-height: 1.4;
    }

    .pagination-controls {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-top: 15px;
        padding: 10px;
        background: #3a3a5a;
        border-top: 1px solid #444;
    }

    .pagination-btn {
        padding: 8px 16px;
        font-size: 0.9rem;
    }

    .indicator-tabs {
        margin: 2px 0 5px 0;
        padding: 0;
    }

    .nav-tabs .nav-link {
        padding: 4px 12px;
        font-size: 0.85rem;
    }

    .combined-tabs-container {
        margin: 2px 0 5px 0;
        padding: 0;
    }

    .combined-tabs {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        width: 100%;
        gap: 10px; /* 减少组间间隙 */
        flex-wrap: nowrap;
        overflow-x: auto;
    }

    .period-tabs-container,
    .main-overlay-tabs-container,
    .indicator-tabs-container {
        flex: none;
        text-align: center;
        white-space: nowrap;
    }

    .period-tabs-container .nav-tabs,
    .main-overlay-tabs-container .nav-tabs,
    .indicator-tabs-container .nav-tabs {
        border-bottom: 1px solid #444;
        margin-bottom: 0;
        display: inline-flex;
        justify-content: center;
        flex-wrap: nowrap;
    }

    .period-tabs-container .nav-tabs .nav-link,
    .main-overlay-tabs-container .nav-tabs .nav-link,
    .indicator-tabs-container .nav-tabs .nav-link {
        padding: 4px 8px;
        font-size: 0.8rem;
        border: 1px solid #444;
        border-bottom: none;
        color: #bbb;
        border-top-left-radius: 2px;
        border-top-right-radius: 2px;
        margin-right: 1px;
        white-space: nowrap;
    }

    .period-tabs-container .nav-tabs .nav-link.active,
    .main-overlay-tabs-container .nav-tabs .nav-link.active,
    .indicator-tabs-container .nav-tabs .nav-link.active {
        background-color: #3a3a5a;
        color: #fff;
        border-color: #555 #555 #3a3a5a;
    }

    .period-tabs-container .nav-tabs .nav-link:hover,
    .main-overlay-tabs-container .nav-tabs .nav-link:hover,
    .indicator-tabs-container .nav-tabs .nav-link:hover {
        background-color: #33334d;
        border-color: #555 #555 #444;
    }

    .period-tabs-container .nav-tabs .nav-link.active,
    .main-overlay-tabs-container .nav-tabs .nav-link.active,
    .indicator-tabs-container .nav-tabs .nav-link.active {
        color: #fff;
        background-color: #444466;
        border-color: #444;
        border-bottom: 1px solid #444466;
    }
</style>

<div class="main-container">
    <!-- 左右两侧统一的头部 -->
    <div class="panel left-panel">
        <div class="panel-header" style="display: none;">
            <div class="stock-info">
                <span id="stock-name" style="display: none;">{{ name }}</span>
                <span id="stock-code" style="display: none;">{{ code }}</span>
            </div>
        </div>

        <div class="chart-container">
                    <!-- 主图叠加和指标图选项卡 -->
                    <div class="combined-tabs-container">
                        <div class="combined-tabs">
                            <!-- 周期选择选项卡 -->
                            <div class="period-tabs-container">
                                <ul class="nav nav-tabs" id="periodTabs">
                                    <li class="nav-item">
                                        <a class="nav-link active" data-period="daily" href="#">日线</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" data-period="weekly" href="#">周线</a>
                                    </li>
                                </ul>
                            </div>

                            <!-- 主图叠加选项卡 -->
                            <div class="main-overlay-tabs-container">
                                <ul class="nav nav-tabs" id="mainOverlayTabs">
                                    <li class="nav-item">
                                        <a class="nav-link" data-overlay="none" href="#">无叠加</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link active" data-overlay="ma" href="#">MA</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" data-overlay="boll" href="#">BOLL</a>
                                    </li>
                                </ul>
                            </div>

                            <!-- 指标图选项卡 -->
                            <div class="indicator-tabs-container">
                                <ul class="nav nav-tabs" id="indicatorTabs">
                                    <li class="nav-item">
                                        <a class="nav-link active" data-indicator="macd" href="#">MACD</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" data-indicator="rsi" href="#">RSI</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" data-indicator="kdj" href="#">KDJ</a>
                                    </li>
                                                                <li class="nav-item">
                                                                    <a class="nav-link" data-indicator="obv" href="#">OBV</a>
                                                                </li>
                                                                <li class="nav-item">
                                                                    <a class="nav-link" data-indicator="roc" href="#">ROC</a>
                                                                </li>
                                </ul>
                            </div>
                        </div>
            </div>

            <!-- 统一图表区域 -->
            <div class="unified-chart-area">
                <div id="unified-chart" style="width: 100%; height: 100%;"></div>
            </div>
        </div>
    </div>

    <!-- 右侧信息区域 -->
    <div class="panel right-panel">
        <div class="panel-header">
            <div class="stock-info">
                <i class="fas fa-info-circle"></i> 股票分析信息
            </div>
                <div class="btn-group-custom">
                    <button class="btn-custom btn-secondary btn-sm" id="prev-btn">上一个</button>
                    <button class="btn-custom btn-secondary btn-sm" id="next-btn">下一个</button>
                </div>
        </div>

        <div class="info-container">
            <!-- 股票详细信息表格 -->
            <div class="stock-details-table">
                <table class="table table-striped table-bordered table-hover">
                    <thead class="thead-dark">
                        <tr>
                            <th>智能体</th>
                            <th>策略名称</th>
                            <th>分数</th>
                            <th>内容</th>
                        </tr>
                    </thead>
                    <tbody id="stock-details-tbody">
                        <!-- 数据将通过JavaScript动态填充 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- ECharts JS -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.0/dist/echarts.min.js"></script>
<script>
    // Template variables passed from Flask
    const stockCodeFromTemplate = "{{ code }}" || "";
    const stockNameFromTemplate = "{{ name }}" || "";
</script>
<script>
    // Global variables
    let stockCode = '';
    let stockName = '';
    let klineData = [];
    let stockInfo = {};
    let currentPage = 0;
    let pageSize = 100;
    let chartInstance = null;
    let mainOverlayType = 'ma';  // 主图叠加类型: none, ma, boll
    let indicatorType = 'macd';  // 指标图类型: macd, rsi, kdj
    let stockPool = [];  // 股票池数据
    let currentStockIndex = -1;  // 当前股票在股票池中的索引
    let currentPeriod = 'daily'; // 当前周期: daily, weekly

    // Function to initialize the page with stock data
    function initializeStockKline(code, name) {
        console.log('Initializing stock kline with code:', code, 'name:', name);
        stockCode = code;
        stockName = name;

        // Load K-line data
        loadStockKlineData(code);

        // Load stock info data
        loadStockInfoData(code);

        // Load stock pool data to enable navigation
        loadStockPoolData();
    }

    // Function to load K-line data for a stock
    function loadStockKlineData(code) {
        console.log('Loading K-line data for code:', code);
        fetch(`/api/stock-kline-realtime/${code}`)
            .then(response => {
                console.log('API response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                return response.json();
            })
            .then(data => {
                console.log('Received data:', data);
                if (data.error) {
                    console.error('Error loading K-line data:', data.error);
                    return;
                }

                // Process the data to ensure it matches expected format
                klineData = data.map(item => ({
                    date: item.date,
                    open: parseFloat(item.open),
                    high: parseFloat(item.high),
                    low: parseFloat(item.low),
                    close: parseFloat(item.close),
                    volume: parseFloat(item.volume)
                }));

                console.log('Processed klineData:', klineData);
                renderCharts();
            })
            .catch(error => {
                console.error('Error loading K-line data:', error);
            });
    }

    // Function to load stock info data
    function loadStockInfoData(code) {
        console.log('Loading stock info data for code:', code);
        fetch(`/api/pool-data/${code}`)
            .then(response => {
                console.log('API response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Received stock info data:', data);
                if (data.error) {
                    console.error('Error loading stock info data:', data.error);
                    return;
                }

                // Store the stock info data
                stockInfo = data;

                // Display the stock info
                displayStockInfo();
            })
            .catch(error => {
                console.error('Error loading stock info data:', error);
            });
    }


    // Function to load stock pool data
    function loadStockPoolData() {
        console.log('Loading stock pool data');
        fetch('/api/latest-pool-stocks')
            .then(response => {
                console.log('API response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Received stock pool data:', data);
                stockPool = data;

                // Find the current stock index in the pool
                currentStockIndex = stockPool.findIndex(stock => stock.code === stockCode);
                console.log('Current stock index:', currentStockIndex);

                // Update button states
                updateNavigationButtons();
            })
            .catch(error => {
                console.error('Error loading stock pool data:', error);
            });
    }

    // Function to update navigation button states
    function updateNavigationButtons() {
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');

        if (!prevBtn || !nextBtn) {
            console.error('Navigation buttons not found');
            return;
        }

        // Disable/enable previous button
        if (currentStockIndex <= 0) {
            prevBtn.disabled = true;
            prevBtn.classList.add('btn-secondary');
            prevBtn.classList.remove('btn-primary');
        } else {
            prevBtn.disabled = false;
            prevBtn.classList.remove('btn-secondary');
            prevBtn.classList.add('btn-primary');
        }

        // Disable/enable next button
        if (currentStockIndex >= stockPool.length - 1) {
            nextBtn.disabled = true;
            nextBtn.classList.add('btn-secondary');
            nextBtn.classList.remove('btn-primary');
        } else {
            nextBtn.disabled = false;
            nextBtn.classList.remove('btn-secondary');
            nextBtn.classList.add('btn-primary');
        }
    }

    // Function to navigate to a specific stock
    function navigateToStock(index) {
        if (index < 0 || index >= stockPool.length) {
            console.error('Invalid stock index:', index);
            return;
        }

        const stock = stockPool[index];
        console.log('Navigating to stock:', stock.code, stock.name);

        // Update current stock index
        currentStockIndex = index;

        // Update stock code and name
        stockCode = stock.code;
        stockName = stock.name || stock.code;

        // Update URL without reloading the page
        const url = new URL(window.location);
        url.searchParams.set('code', stockCode);
        url.searchParams.set('name', stockName);
        window.history.replaceState({}, '', url);

        // Load data for the new stock
        loadStockKlineData(stockCode);
        loadStockInfoData(stockCode);

        // Update button states
        updateNavigationButtons();
    }

    // Function to navigate to the previous stock
    function navigateToPreviousStock() {
        console.log('Navigating to previous stock, current index:', currentStockIndex);
        if (currentStockIndex > 0) {
            navigateToStock(currentStockIndex - 1);
        }
    }

    // Function to navigate to the next stock
    function navigateToNextStock() {
        console.log('Navigating to next stock, current index:', currentStockIndex);
        if (currentStockIndex < stockPool.length - 1) {
            navigateToStock(currentStockIndex + 1);
        }
    }

    // Function to display stock info in hierarchical structure
    function displayStockInfo() {
        console.log('Displaying stock info:', stockInfo);
        const tbody = document.getElementById('stock-details-tbody');
        if (!tbody) {
            console.error('Could not find stock-details-tbody element');
            return;
        }
        tbody.innerHTML = ''; // Clear existing data

        // Display strategy information in table format (Agent, Strategy Name, Score, Value)
        displayStrategySection('signals', '信号生成', stockInfo.signals, tbody);
        displayStrategySection('trend', '趋势策略', stockInfo.trend, tbody);
        displayStrategySection('tech', '技术策略', stockInfo.tech, tbody);
        displayStrategySection('fund', '基本面策略', stockInfo.fund, tbody);
        displayStrategySection('pub', '舆情策略', stockInfo.pub, tbody);
    }

    // Function to display a section of strategies in table format
    // Function to display strategy section in table format
    function displayStrategySection(agentKey, agentName, strategies, tbody) {
        if (!strategies || typeof strategies !== 'object') {
            return;
        }

        // Special handling for signals section to display "信号生成V1" data first
        if (agentKey === 'signals') {
            // First display "信号生成V1" if it exists
            if (strategies['信号生成V1']) {
                const signalData = strategies['信号生成V1'];
                const row = document.createElement('tr');

                // Format the signal data for display
                let signalContent = '';
                if (typeof signalData === 'object' && signalData !== null) {
                    signalContent = `
                        <div>
                            <div><strong>满足策略数:</strong> ${signalData.counts || 0}</div>
                            <div><strong>计算信号:</strong> ${signalData.signal_calc || ''}</div>
                            <div><strong>AI信号:</strong> ${signalData.signal_ai || ''}</div>
                            <div><strong>计算分数:</strong> ${signalData.score_calc !== undefined ? signalData.score_calc.toFixed(4) : ''}</div>
                            <div><strong>AI分数:</strong> ${signalData.score_ai !== undefined ? signalData.score_ai.toFixed(4) : ''}</div>
                            <div><strong>AI分析:</strong> ${signalData.reason_ai || ''}</div>
                        </div>
                    `;
                } else {
                    signalContent = formatValueForTable(signalData);
                }

                // Use action field for score column in signals section
                const action = signalData.action !== undefined ? signalData.action : '';

                row.innerHTML = `
                    <td>${agentName}</td>
                    <td>信号生成V1</td>
                    <td>${action}</td>
                    <td>${signalContent}</td>
                `;

                tbody.appendChild(row);
            }

            // Then display other signals
            for (const [strategyName, strategyData] of Object.entries(strategies)) {
                if (strategyName === '信号生成V1') continue; // Skip as it's already displayed

                const row = document.createElement('tr');

                // Get score and value
                const score = strategyData.score !== undefined ?
                    (typeof strategyData.score === 'number' ? strategyData.score.toFixed(2) : strategyData.score) :
                    '';

                const value = strategyData.value !== undefined ?
                    formatValueForTable(strategyData.value) :
                    '';

                row.innerHTML = `
                    <td>${agentName}</td>
                    <td>${strategyName}</td>
                    <td>${score}</td>
                    <td>${value}</td>
                `;

                tbody.appendChild(row);
            }
        } else {
            // Handle other sections normally
            for (const [strategyName, strategyData] of Object.entries(strategies)) {
                const row = document.createElement('tr');

                // Get score and value
                const score = strategyData.score !== undefined ?
                    (typeof strategyData.score === 'number' ? strategyData.score.toFixed(2) : strategyData.score) :
                    '';

                const value = strategyData.value !== undefined ?
                    formatValueForTable(strategyData.value) :
                    '';

                row.innerHTML = `
                    <td>${agentName}</td>
                    <td>${strategyName}</td>
                    <td>${score}</td>
                    <td>${value}</td>
                `;

                tbody.appendChild(row);
            }
        }
    }

    // Helper function to format values for table display
    function formatValueForTable(value) {
        // If value is an object, format it nicely
        if (typeof value === 'object' && value !== null) {
            // For objects with multiple properties, display each property
            if (Object.keys(value).length > 0) {
                let result = '<div>';
                for (const [key, val] of Object.entries(value)) {
                    result += `<div><strong>${key}:</strong> ${val}</div>`;
                }
                result += '</div>';
                return result;
            }
            // For empty objects
            return JSON.stringify(value);
        }
        // For arrays, join elements
        if (Array.isArray(value)) {
            return value.join(', ');
        }
        // For other types, convert to string
        return String(value);
    }


    // Function to render charts
    function renderCharts() {
        console.log('Rendering charts with klineData:', klineData);

        // Use all data instead of paginated data for charts
        let displayData = klineData;

        // Convert to weekly data if weekly period is selected
        if (currentPeriod === 'weekly') {
            displayData = convertDailyToWeekly(klineData);
            console.log('Converted to weekly data:', displayData);
        }

        const pageData = displayData;

        console.log('Page data:', pageData);

        // Prepare data for charts
        const dates = pageData.map(item => item.date);
        const ohlcData = pageData.map(item => [
            item.open,
            item.close,
            item.low,
            item.high
        ]);
        const volumeData = pageData.map(item => item.volume);
        const closes = pageData.map(item => item.close);

        console.log('Chart data prepared - dates:', dates, 'ohlcData:', ohlcData, 'volumeData:', volumeData);

        // Render unified chart with all three components
        renderUnifiedChart(dates, ohlcData, volumeData, closes);
    }

    // Function to render unified chart with K-line, indicator, and volume
    function renderUnifiedChart(dates, ohlcData, volumeData, closes) {
        console.log('Rendering unified chart with dates:', dates, 'mainOverlayType:', mainOverlayType, 'indicatorType:', indicatorType);
        const chartDom = document.getElementById('unified-chart');
        if (!chartDom) {
            console.error('Could not find unified-chart element');
            return;
        }

        try {
            if (typeof chartInstance === 'undefined' || chartInstance === null) {
                chartInstance = echarts.init(chartDom);
            }

            // Calculate indicator data based on selected indicator type
            let indicatorData = [];
            let indicatorName = '';
                        let macdLineData = [];
                        let signalLineData = [];
                        let histogramData = [];
                        let kData = [];
                        let dData = [];
                        let jData = [];
                        let obvData = [];
                        let rocData = [];
            
                        switch(indicatorType) {
                            case 'macd':
                                const macdData = calculateMACD(closes);
                                macdLineData = macdData.macd;
                                signalLineData = macdData.signal;
                                histogramData = macdData.histogram;
                    indicatorName = 'MACD';
                    break;
                case 'rsi':
                    const rsiData = calculateRSI(closes, 14);
                    indicatorData = Array(dates.length).fill(null);
                    for (let i = 0; i < rsiData.length && i < indicatorData.length; i++) {
                        indicatorData[indicatorData.length - rsiData.length + i] = rsiData[i];
                    }
                    indicatorName = 'RSI';
                    break;
                case 'kdj':
                    const kdjData = calculateKDJ(closes);
                                kData = kdjData.k;
                                dData = kdjData.d;
                                jData = kdjData.j;
                                indicatorName = 'KDJ';
                                break;
                            case 'obv':
                                const obvResult = calculateOBV(closes, volumeData);
                                obvData = obvResult;
                                indicatorName = 'OBV';
                                break;
                            case 'roc':
                                const rocResult = calculateROC(closes, 12);
                                rocData = rocResult;
                                indicatorName = 'ROC';
                                break;
                default:
                    indicatorData = Array(dates.length).fill(null);
                    indicatorName = 'MACD';
            }

            // Color bars based on price change for volume chart
            const volumeColors = volumeData.map((volume, index) => {
                if (index > 0) {
                    const currentClose = closes[index];
                    const previousClose = closes[index - 1];
                    return currentClose >= previousClose ? '#ef232a' : '#14b143';
                }
                return '#14b143';
            });

                        // Calculate short-term and medium-term volume moving averages
                        const shortTermVolumeMA = calculateMA(volumeData, 5);  // 5-period MA
                        const mediumTermVolumeMA = calculateMA(volumeData, 10);   // 10-period MA
            
            // Prepare series data for main chart overlays
            let overlaySeries = [];

            // Add overlay series based on selected overlay type
            if (mainOverlayType === 'ma') {
                // Get MA parameters from strategy configuration
                let maParams = { short: 5, mid: 13, long: 34 }; // Default values

                // Calculate MA data
                let maShortData = calculateMA(closes, maParams.short);
                let maMidData = calculateMA(closes, maParams.mid);
                let maLongData = calculateMA(closes, maParams.long);

                // Add MA series to overlay
                overlaySeries = [
                    {
                        name: `MA${maParams.short}`,
                        type: 'line',
                        data: maShortData,
                        smooth: true,
                        showSymbol: false,
                        lineStyle: {
                            width: 1,
                            color: '#ffffff'
                        },
                        xAxisIndex: 0,
                        yAxisIndex: 0
                    },
                    {
                        name: `MA${maParams.mid}`,
                        type: 'line',
                        data: maMidData,
                        smooth: true,
                        showSymbol: false,
                        lineStyle: {
                            width: 2,
                            color: '#ffff00'
                        },
                        xAxisIndex: 0,
                        yAxisIndex: 0
                    },
                    {
                        name: `MA${maParams.long}`,
                        type: 'line',
                        data: maLongData,
                        smooth: true,
                        showSymbol: false,
                        lineStyle: {
                            width: 3,
                            color: '#ff00ff'
                        },
                        xAxisIndex: 0,
                        yAxisIndex: 0
                    }
                ];
            } else if (mainOverlayType === 'boll') {
                // Calculate BOLL with classic parameters (20-period SMA, 2 standard deviations)
                const bollData = calculateBOLL(closes, 20, 2);

                // Add BOLL series to overlay
                overlaySeries = [
                    {
                        name: 'BOLL_UPPER',
                        type: 'line',
                        data: bollData.upper,
                        smooth: true,
                        showSymbol: false,
                        lineStyle: {
                            width: 2,
                            color: '#ff3300'
                        },
                        xAxisIndex: 0,
                        yAxisIndex: 0
                    },
                    {
                        name: 'BOLL_MIDDLE',
                        type: 'line',
                        data: bollData.middle,
                        smooth: true,
                        showSymbol: false,
                        lineStyle: {
                            width: 2,
                            color: '#00ff00'
                        },
                        xAxisIndex: 0,
                        yAxisIndex: 0
                    },
                    {
                        name: 'BOLL_LOWER',
                        type: 'line',
                        data: bollData.lower,
                        smooth: true,
                        showSymbol: false,
                        lineStyle: {
                            width: 2,
                            color: '#3333ff'
                        },
                        xAxisIndex: 0,
                        yAxisIndex: 0
                    }
                ];
            }

            const option = {
                backgroundColor: 'transparent',
                title: {
                    text: stockName + ' (' + stockCode + ')',
                    textStyle: {
                        color: '#e6e6e6',
                        fontSize: 14
                    },
                    left: 'center',
                    top: 5
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    },
                    formatter: function(params) {
                        let result = `<div style="font-size: 14px; margin-bottom: 5px;">${params[0].axisValue}</div>`;

                        params.forEach(param => {
                            if (param.seriesName === 'K线图') {
                                // K线数据 - 先显示基本信息
                                const data = param.data;
                                result += `<div style="display: flex; align-items: center; margin: 2px 0;">
                                    <span style="color: ${param.color}; margin-right: 8px;">●</span>
                                    <span style="min-width: 60px;">${param.seriesName}</span>
                                </div>
                                <div style="margin-left: 24px; margin-bottom: 4px;">
                                    <div>开: ${data[0].toFixed(2)}</div>
                                    <div>收: ${data[1].toFixed(2)}</div>
                                    <div>低: ${data[2].toFixed(2)}</div>
                                    <div>高: ${data[3].toFixed(2)}</div>
                                </div>`;
                            } else if (param.seriesName === '成交量' || param.seriesName === '短期成交量MA' || param.seriesName === '中期成交量MA') {
                                // 成交量数据 - 包括MA成交量
                                const volume = param.data;
                                result += `<div style="display: flex; align-items: center; margin: 2px 0;">
                                    <span style="color: ${param.color}; margin-right: 8px;">●</span>
                                    <span style="min-width: 60px;">${param.seriesName}</span>
                                    <span style="margin-left: 10px;">${Math.round(volume / 10000)}W</span>
                                </div>`;
                            } else if (param.seriesName === 'Histogram') {
                                // MACD柱状图
                                result += `<div style="display: flex; align-items: center; margin: 2px 0;">
                                    <span style="color: ${param.color}; margin-right: 8px;">●</span>
                                    <span style="min-width: 60px;">${param.seriesName}</span>
                                    <span style="margin-left: 10px;">${param.data.toFixed(2)}</span>
                                </div>`;
                            } else {
                                // 其他指标数据
                                result += `<div style="display: flex; align-items: center; margin: 2px 0;">
                                    <span style="color: ${param.color}; margin-right: 8px;">●</span>
                                    <span style="min-width: 60px;">${param.seriesName}</span>
                                    <span style="margin-left: 10px;">${param.data !== null && param.data !== undefined ? param.data.toFixed(2) : '--'}</span>
                                </div>`;
                            }
                        });

                        return result;
                    }
                            },
                            axisPointer: {
                                link: [
                                    {
                                        xAxisIndex: 'all'
                                    }
                                ],
                                label: {
                                    backgroundColor: '#777',
                                    formatter: function(params) {
                                        // Format y-axis value based on the grid
                                        if (params.axisDimension === 'y') {
                                            if (params.seriesIndex === undefined || params.seriesIndex === null) {
                                                // For K-line grid (gridIndex 0)
                                                if (params.axisIndex === 0) {
                                                    return params.value.toFixed(2);
                                                }
                                                // For indicator grid (gridIndex 1)
                                                else if (params.axisIndex === 1) {
                                                    return params.value.toFixed(2);
                                                }
                                                // For volume grid (gridIndex 2)
                                                else if (params.axisIndex === 2) {
                                                    return Math.round(params.value / 10000) + 'W';
                                                }
                                            }
                                        }
                                        return params.value;
                                    }
                                }
                },
                grid: [
                    {
                        // K-line grid
                        left: '8%',
                        right: '8%',
                        top: '8%',
                        height: '44%',
                        borderColor: '#555',
                        borderWidth: 1
                    },
                    {
                        // Indicator grid
                        left: '8%',
                        right: '8%',
                        top: '55%',
                        height: '26%',
                        borderColor: '#555',
                        borderWidth: 1
                    },
                    {
                        // Volume grid
                        left: '8%',
                        right: '8%',
                        top: '84%',
                        height: '11.2%',
                        borderColor: '#555',
                        borderWidth: 1
                    }
                ],
                xAxis: [
                    {
                        // K-line x-axis (hidden)
                        type: 'category',
                        data: dates,
                        scale: true,
                        boundaryGap: false,
                        gridIndex: 0,
                        axisLine: { onZero: false, lineStyle: { color: '#777' } },
                        axisTick: { show: false },
                        splitLine: { show: true, lineStyle: { color: '#444' } },
                        axisLabel: { show: false }
                    },
                    {
                        // Indicator x-axis (hidden)
                        type: 'category',
                        data: dates,
                        scale: true,
                        boundaryGap: false,
                        gridIndex: 1,
                        axisLine: { onZero: false, lineStyle: { color: '#777' } },
                        axisTick: { show: false },
                        splitLine: { show: true, lineStyle: { color: '#444' } },
                        axisLabel: { show: false }
                    },
                    {
                        // Volume x-axis (visible)
                        type: 'category',
                        data: dates,
                        scale: true,
                        boundaryGap: false,
                        gridIndex: 2,
                        axisLine: { onZero: false, lineStyle: { color: '#777' } },
                        splitLine: { show: true, lineStyle: { color: '#444' } },
                        axisLabel: {
                            color: '#a0a0c0',
                            formatter: function(value) {
                                // Format date to show only month/day
                                if (value && value.length >= 10) {
                                    return value.substring(5, 10);
                                }
                                return value;
                            }
                        }
                    }
                ],
                yAxis: [
                    {
                        // K-line y-axis
                        scale: true,
                        gridIndex: 0,
                        splitArea: { show: false },
                        axisLabel: { color: '#a0a0c0' },
                        axisLine: { lineStyle: { color: '#777' } },
                        splitLine: { show: true, lineStyle: { color: '#444' } }
                    },
                    {
                        // Indicator y-axis
                        scale: true,
                        gridIndex: 1,
                        axisLabel: { color: '#a0a0c0' },
                        axisLine: { lineStyle: { color: '#777' } },
                        splitLine: { show: true, lineStyle: { color: '#444' } }
                    },
                    {
                        // Volume y-axis
                        scale: true,
                        gridIndex: 2,
                        axisLabel: {
                            color: '#a0a0c0',
                            formatter: function(value) {
                                // Divide by 10000 and show as integer with 'W' suffix
                                return Math.round(value / 10000) + 'W';
                            }
                        },
                        axisLine: { lineStyle: { color: '#777' } },
                        splitLine: { show: true, lineStyle: { color: '#444' } }
                    }
                ],
                dataZoom: [
                    {
                        type: 'inside',
                        xAxisIndex: [0, 1, 2],
                        start: Math.max(0, 100 - (90 / dates.length) * 100),
                        end: 100
                    },
                    {
                        show: true,
                        xAxisIndex: [0, 1, 2],
                        type: 'slider',
                        bottom: 0,
                        height: 10,
                        start: Math.max(0, 100 - (90 / dates.length) * 100),
                        end: 100
                    }
                ],
                series: [
                    {
                        name: 'K线图',
                        type: 'candlestick',
                        data: ohlcData,
                        itemStyle: {
                            color: '#ef232a',
                            color0: '#14b143',
                            borderColor: '#ef232a',
                            borderColor0: '#14b143'
                        },
                        xAxisIndex: 0,
                        yAxisIndex: 0
                    },
                    // Add overlay series
                    ...overlaySeries,
                                        // Add MACD series when indicatorType is 'macd'
                                        ...(indicatorType === 'macd' ? [
                                            {
                                                name: 'MACD',
                                                type: 'line',
                                                data: macdLineData,
                                                smooth: true,
                                                showSymbol: false,
                                                lineStyle: {
                                                    width: 1,
                                                                                            color: '#ffffff'  // White color for MACD line
                                                                                        },
                                                                                        xAxisIndex: 1,
                                                                                        yAxisIndex: 1,
                                                                                        label: {
                                                                                            show: false,
                                                                                            position: 'top',
                                                                                            formatter: function(params) {
                                                                                                return params.value.toFixed(2);
                                                                                            },
                                                                                            color: '#ffffff',
                                                                                            fontSize: 10
                                                                                        }
                                            },
                                            {
                                                name: 'Signal',
                                                type: 'line',
                                                data: signalLineData,
                                                smooth: true,
                                                showSymbol: false,
                                                lineStyle: {
                                                    width: 1,
                                                                                            color: '#ffff00'  // Yellow color for Signal line
                                                                                        },
                                                                                        xAxisIndex: 1,
                                                                                        yAxisIndex: 1,
                                                                                        label: {
                                                                                            show: false,
                                                                                            position: 'top',
                                                                                            formatter: function(params) {
                                                                                                return params.value.toFixed(2);
                                                                                            },
                                                                                            color: '#ffff00',
                                                                                            fontSize: 10
                                                                                        }
                                                                                    },
                                                                                    {
                                                                                        name: 'Histogram',
                                                                                        type: 'bar',
                                                                                        data: histogramData,
                                                                                        barWidth: '60%',
                                                                                        itemStyle: {
                                                                                            color: function(params) {
                                                                                                // Color bars based on value: red for positive (bullish/up), green for negative (bearish/down)
                                                                                                return params.value >= 0 ? '#ff0000' : '#00ff00';
                                                                                            }
                                                                                        },
                                                                                        xAxisIndex: 1,
                                                                                        yAxisIndex: 1,
                                                                                        label: {
                                                                                            show: false,
                                                                                            position: 'top',
                                                                                            formatter: function(params) {
                                                                                                return params.value.toFixed(2);
                                                                                            },
                                                                                            color: function(params) {
                                                                                                return params.value >= 0 ? '#ff0000' : '#00ff00';
                                                                                            },
                                                                                            fontSize: 8
                                                                                        }
                                                                                    }
                                                                                ] : indicatorType === 'kdj' ? [
                                                                                    {
                                                                                        name: 'K',
                                                                                        type: 'line',
                                                                                        data: kData,
                                                                                        smooth: true,
                                                                                        showSymbol: false,
                                                                                        lineStyle: {
                                                                                            width: 1,
                                                                                            color: '#ffffff'  // White color for K line
                                                                                        },
                                                                                        xAxisIndex: 1,
                                                                                        yAxisIndex: 1
                                                                                    },
                                                                                    {
                                                                                        name: 'D',
                                                                                        type: 'line',
                                                                                        data: dData,
                                                                                        smooth: true,
                                                                                        showSymbol: false,
                                                                                        lineStyle: {
                                                                                            width: 1,
                                                                                            color: '#ffff00'  // Yellow color for D line
                                                                                        },
                                                                                        xAxisIndex: 1,
                                                                                        yAxisIndex: 1
                                                                                    },
                                                                                    {
                                                                                        name: 'J',
                                                                                        type: 'line',
                                                                                        data: jData,
                                                                                        smooth: true,
                                                                                        showSymbol: false,
                                                                                        lineStyle: {
                                                                                            width: 1,
                                                                                            color: '#ff00ff'  // Magenta color for J line
                                                                                        },
                                                                                        xAxisIndex: 1,
                                                                                        yAxisIndex: 1
                                                                                    }
                                                                                ] : indicatorType === 'rsi' ? [
                                                                                    {
                                                                                        name: 'RSI',
                                                                                        type: 'line',
                                                                                        data: indicatorData,
                                                                                        smooth: true,
                                                                                        showSymbol: false,
                                                                                        lineStyle: {
                                                                                            width: 2,
                                                                                            color: '#ff3333'  // Red color for RSI line
                                                                                        },
                                                                                        xAxisIndex: 1,
                                                                                        yAxisIndex: 1
                                                                                    }
                                                                                ] : indicatorType === 'obv' ? [
                                                                                    {
                                                                                        name: 'OBV',
                                                                                        type: 'line',
                                                                                        data: obvData,
                                                                                        smooth: true,
                                                                                        showSymbol: false,
                                                                                        lineStyle: {
                                                                                            width: 2,
                                                                                            color: '#3333ff'  // Blue color for OBV line
                                                                                        },
                                                                                        xAxisIndex: 1,
                                                                                        yAxisIndex: 1
                                                                                    }
                                                                                ] : indicatorType === 'roc' ? [
                                                                                    {
                                                                                        name: 'ROC',
                                                                                        type: 'line',
                                                                                        data: rocData,
                                                                                        smooth: true,
                                                                                        showSymbol: false,
                                                                                        lineStyle: {
                                                                                            width: 2,
                                                                                            color: '#00ff00'  // Green color for ROC line
                                                                                        },
                                                                                        xAxisIndex: 1,
                                                                                        yAxisIndex: 1
                                                                                    }
                                                                                ] : []),
                    {
                        name: '成交量',
                        type: 'bar',
                        data: volumeData,
                        itemStyle: {
                            color: function(params) {
                                return volumeColors[params.dataIndex];
                            }
                        },
                        xAxisIndex: 2,
                        yAxisIndex: 2
                                        },
                                        {
                                            name: '短期成交量MA',
                                            type: 'line',
                                            data: shortTermVolumeMA,
                                            smooth: true,
                                            showSymbol: false,
                                            lineStyle: {
                                                width: 1,
                                                                    color: '#ffffff'
                                            },
                                            xAxisIndex: 2,
                                            yAxisIndex: 2
                                        },
                                        {
                                            name: '中期成交量MA',
                                            type: 'line',
                                            data: mediumTermVolumeMA,
                                            smooth: true,
                                            showSymbol: false,
                                            lineStyle: {
                                                width: 1,
                                                                    color: '#ffff00'
                                            },
                                            xAxisIndex: 2,
                                            yAxisIndex: 2
                    }
                ]
            };

            chartInstance.setOption(option, true);
        } catch (error) {
            console.error('Error rendering unified chart:', error);
        }
    }

    // Function to switch period (daily/weekly)
    function switchPeriod(periodType) {
        currentPeriod = periodType;

        // Save user preference to localStorage
        localStorage.setItem('selectedPeriod', periodType);

        // Update active tab
        document.querySelectorAll('#periodTabs .nav-link').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelector(`[data-period="${periodType}"]`).classList.add('active');

        // Re-render charts with the selected period data
        renderCharts();
    }

    // Function to switch main chart overlay
    function switchMainOverlay(overlayType) {
        mainOverlayType = overlayType;

        // Save user preference to localStorage
        localStorage.setItem('selectedMainOverlay', overlayType);

            // Update active tab
            document.querySelectorAll('#mainOverlayTabs .nav-link').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-overlay="${overlayType}"]`).classList.add('active');

        renderCharts();
    }

    // Function to switch indicator chart
    function switchIndicator(indicatorTypeParam) {
        indicatorType = indicatorTypeParam;

        // Save user preference to localStorage
        localStorage.setItem('selectedIndicator', indicatorType);
    
            // Update active tab
            document.querySelectorAll('#indicatorTabs .nav-link').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-indicator="${indicatorTypeParam}"]`).classList.add('active');
    
        renderCharts();
    }

    // Function to toggle info display
    function toggleInfoDisplay(infoType) {
        if (infoType === 'json') {
            document.getElementById('json-display').parentElement.classList.remove('d-none');
            document.getElementById('formatted-display').classList.add('d-none');
        } else {
            document.getElementById('json-display').parentElement.classList.add('d-none');
            document.getElementById('formatted-display').classList.remove('d-none');
        }
    }

    // Function to toggle fullscreen
    function toggleFullscreen() {
        const elem = document.documentElement;
        if (!document.fullscreenElement) {
            if (elem.requestFullscreen) {
                elem.requestFullscreen();
            } else if (elem.webkitRequestFullscreen) { /* Safari */
                elem.webkitRequestFullscreen();
            } else if (elem.msRequestFullscreen) { /* IE11 */
                elem.msRequestFullscreen();
            }
            document.getElementById('fullscreen-btn').innerHTML = '<i class="fas fa-compress"></i> 退出全屏';
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) { /* Safari */
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) { /* IE11 */
                document.msExitFullscreen();
            }
            document.getElementById('fullscreen-btn').innerHTML = '<i class="fas fa-expand"></i> 全屏';
        }
    }

    // Helper function to calculate EMA
    function calculateEMA(data, period) {
        if (!data || data.length < period || period <= 0) return [];

        const k = 2 / (period + 1);
        const ema = [data[0]];

        for (let i = 1; i < data.length; i++) {
            ema.push(data[i] * k + ema[i - 1] * (1 - k));
        }

        return ema;
    }

    // Helper function to calculate MACD
    function calculateMACD(data) {
        if (!data || data.length < 26) return { macd: [], signal: [], histogram: [] };

        const ema12 = calculateEMA(data, 12);
        const ema26 = calculateEMA(data, 26);

        const macd = [];
        for (let i = 0; i < ema12.length && i < ema26.length; i++) {
            macd.push(ema12[i] - ema26[i]);
        }

        const signal = calculateEMA(macd, 9);
        const histogram = [];
        for (let i = 0; i < macd.length && i < signal.length; i++) {
            histogram.push(macd[i] - signal[i]);
        }

        return {
            macd: macd,
            signal: signal,
            histogram: histogram
        };
    }

    // Helper function to calculate RSI
    function calculateRSI(data, period) {
        if (!data || data.length <= period) return [];

        const rsi = [];
        let gains = 0;
        let losses = 0;

        // Calculate initial average gain and loss
        for (let i = 1; i <= period; i++) {
            const change = data[i] - data[i - 1];
            if (change > 0) {
                gains += change;
            } else {
                losses -= change;
            }
        }

        let avgGain = gains / period;
        let avgLoss = losses / period;
        let rs = avgLoss !== 0 ? avgGain / avgLoss : 0;
        rsi.push(100 - (100 / (1 + rs)));

        // Calculate subsequent values using smoothing
        for (let i = period + 1; i < data.length; i++) {
            const change = data[i] - data[i - 1];
            const gain = change > 0 ? change : 0;
            const loss = change < 0 ? -change : 0;

            avgGain = (avgGain * (period - 1) + gain) / period;
            avgLoss = (avgLoss * (period - 1) + loss) / period;
            rs = avgLoss !== 0 ? avgGain / avgLoss : 0;
            rsi.push(100 - (100 / (1 + rs)));
        }

        return rsi;
    }

    // Helper function to calculate KDJ
    function calculateKDJ(closes) {
        if (closes.length < 9) return { k: [], d: [], j: [] };

        const kValues = [];
        const dValues = [];
        const jValues = [];

        let prevK = 50;
        let prevD = 50;

        // We need high and low data for KDJ, but we only have close data
        // For simplicity, we'll estimate high/low based on close data
        // In a real implementation, you would pass the full OHLC data
        const highs = closes.map((close, index) => {
            if (index === 0) return close;
            return Math.max(close, closes[index - 1]);
        });

        const lows = closes.map((close, index) => {
            if (index === 0) return close;
            return Math.min(close, closes[index - 1]);
        });

        for (let i = 0; i < closes.length; i++) {
            if (i < 8) {
                kValues.push(null);
                dValues.push(null);
                jValues.push(null);
                continue;
            }

            const periodHighs = highs.slice(i - 8, i + 1);
            const periodLows = lows.slice(i - 8, i + 1);

            const highestHigh = Math.max(...periodHighs);
            const lowestLow = Math.min(...periodLows);
            const close = closes[i];

            if (highestHigh === lowestLow) {
                kValues.push(prevK);
                dValues.push(prevD);
                jValues.push(3 * prevK - 2 * prevD);
            } else {
                const rsv = ((close - lowestLow) / (highestHigh - lowestLow)) * 100;
                const k = (2/3) * prevK + (1/3) * rsv;
                const d = (2/3) * prevD + (1/3) * k;
                const j = 3 * k - 2 * d;

                kValues.push(k);
                dValues.push(d);
                jValues.push(j);

                prevK = k;
                prevD = d;
            }
        }

        return { k: kValues, d: dValues, j: jValues };
        }

        // Function to convert daily data to weekly data
        function convertDailyToWeekly(dailyData) {
            if (!dailyData || dailyData.length === 0) return [];

            const weeklyData = [];
            let currentWeek = null;

            // Sort data by date (ascending)
            const sortedData = [...dailyData].sort((a, b) => new Date(a.date) - new Date(b.date));

            for (const day of sortedData) {
                const date = new Date(day.date);
                const year = date.getFullYear();
                const week = getWeekNumber(date);
                const weekKey = `${year}-${week}`;

                if (!currentWeek || currentWeek.weekKey !== weekKey) {
                    // Start a new week
                    if (currentWeek) {
                        weeklyData.push(currentWeek);
                    }
                    currentWeek = {
                        date: day.date, // Keep the original date for display
                        weekKey: weekKey,
                        open: day.open,
                        high: day.high,
                        low: day.low,
                        close: day.close,
                        volume: day.volume
                    };
                } else {
                    // Update current week data
                    currentWeek.high = Math.max(currentWeek.high, day.high);
                    currentWeek.low = Math.min(currentWeek.low, day.low);
                    currentWeek.close = day.close;
                    currentWeek.volume += day.volume;
                    // Update date to the last day of the week
                    currentWeek.date = day.date;
                }
            }

            // Add the last week
            if (currentWeek) {
                weeklyData.push(currentWeek);
            }

            console.log('Converted weekly data:', weeklyData);
            return weeklyData;
        }

        // Helper function to get week number
        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil(((d - yearStart) / 86400000 + 1) / 7);
        }

        // Helper function to calculate OBV (On Balance Volume)
        function calculateOBV(closes, volumes) {
            if (!closes || !volumes || closes.length !== volumes.length || closes.length < 2) return [];
    
            const obv = [0]; // Start with 0
    
            for (let i = 1; i < closes.length; i++) {
                if (closes[i] > closes[i - 1]) {
                    // Price increased, add volume
                    obv.push(obv[i - 1] + volumes[i]);
                } else if (closes[i] < closes[i - 1]) {
                    // Price decreased, subtract volume
                    obv.push(obv[i - 1] - volumes[i]);
                } else {
                    // Price unchanged, OBV unchanged
                    obv.push(obv[i - 1]);
                }
            }
    
            return obv;
        }
    
        // Helper function to calculate ROC (Rate of Change)
        function calculateROC(closes, period) {
            if (!closes || closes.length <= period || period <= 0) return [];
    
            const roc = [];
    
            // Fill initial values with null
            for (let i = 0; i < period; i++) {
                roc.push(null);
            }
    
            // Calculate ROC for the rest of the data
            for (let i = period; i < closes.length; i++) {
                const currentValue = closes[i];
                const pastValue = closes[i - period];
                const rateOfChange = ((currentValue - pastValue) / pastValue) * 100;
                roc.push(rateOfChange);
            }
    
            return roc;
    }

    // Helper function to calculate Moving Average
    function calculateMA(data, period) {
        if (!data || data.length < period || period <= 0) return [];

        const ma = [];
        for (let i = 0; i < data.length; i++) {
            if (i < period - 1) {
                ma.push(null);
            } else {
                const sum = data.slice(i - period + 1, i + 1).reduce((a, b) => a + b, 0);
                ma.push(sum / period);
            }
        }

        return ma;
    }

    // Helper function to calculate BOLL (Bollinger Bands)
    function calculateBOLL(data, period, multiplier) {
        if (!data || data.length < period || period <= 0) return { upper: [], middle: [], lower: [] };

        const middle = calculateMA(data, period);
        const upper = [];
        const lower = [];

        for (let i = 0; i < data.length; i++) {
            if (i < period - 1) {
                upper.push(null);
                lower.push(null);
            } else {
                // Calculate standard deviation
                const slice = data.slice(i - period + 1, i + 1);
                const mean = slice.reduce((a, b) => a + b, 0) / period;
                const variance = slice.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / period;
                const stdDev = Math.sqrt(variance);

                upper.push(middle[i] + (multiplier * stdDev));
                lower.push(middle[i] - (multiplier * stdDev));
            }
        }

        return { upper: upper, middle: middle, lower: lower };
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded');
        // Get stock code and name from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        let code = urlParams.get('code');
        let name = urlParams.get('name') || code;

        console.log('URL params - code:', code, 'name:', name);

        // If not in URL params, try to get from template variables
        if (!code && typeof stockCodeFromTemplate !== 'undefined') {
            code = stockCodeFromTemplate;
        }
        if (!name && typeof stockNameFromTemplate !== 'undefined') {
            name = stockNameFromTemplate;
        }

        console.log('Final code:', code, 'name:', name);

        if (code) {
            // 从localStorage获取用户选择的主图叠加类型
            const savedMainOverlay = localStorage.getItem('selectedMainOverlay');
            if (savedMainOverlay) {
                mainOverlayType = savedMainOverlay;
                // 更新主图叠加标签的选中状态
                document.querySelectorAll('#mainOverlayTabs .nav-link').forEach(tab => {
                    tab.classList.remove('active');
                });
                            const activeMainOverlayTab = document.querySelector(`[data-overlay="${savedMainOverlay}"]`);
                            if (activeMainOverlayTab) {
                                activeMainOverlayTab.classList.add('active');
                            }
                        } else {
                            // 默认选中MA
                            mainOverlayType = 'ma';
                            document.querySelectorAll('#mainOverlayTabs .nav-link').forEach(tab => {
                                tab.classList.remove('active');
                            });
                            const defaultMainOverlayTab = document.querySelector(`[data-overlay="ma"]`);
                            if (defaultMainOverlayTab) {
                                defaultMainOverlayTab.classList.add('active');
                            }
            }

            // 从localStorage获取用户选择的指标类型
            const savedIndicator = localStorage.getItem('selectedIndicator');
            if (savedIndicator) {
                indicatorType = savedIndicator;
                // 更新指标图标签的选中状态
                document.querySelectorAll('#indicatorTabs .nav-link').forEach(tab => {
                    tab.classList.remove('active');
                });
                            const activeIndicatorTab = document.querySelector(`[data-indicator="${savedIndicator}"]`);
                            if (activeIndicatorTab) {
                                activeIndicatorTab.classList.add('active');
                            }
                        } else {
                            // 默认选中MACD
                            indicatorType = 'macd';
                            document.querySelectorAll('#indicatorTabs .nav-link').forEach(tab => {
                                tab.classList.remove('active');
                            });
                            const defaultIndicatorTab = document.querySelector(`[data-indicator="macd"]`);
                            if (defaultIndicatorTab) {
                                defaultIndicatorTab.classList.add('active');
                            }
            }

            // Initialize stock kline
            initializeStockKline(code, name);
        } else {
            console.error('No stock code provided');
        }

        // Add event listeners for period tabs
        document.querySelectorAll('#periodTabs .nav-link').forEach(tab => {
            tab.addEventListener('click', function(e) {
                e.preventDefault();
                const periodType = this.getAttribute('data-period');

                // Switch period
                switchPeriod(periodType);
            });
        });

        // Add event listeners for main overlay tabs
        document.querySelectorAll('#mainOverlayTabs .nav-link').forEach(tab => {
            tab.addEventListener('click', function(e) {
                e.preventDefault();
                const overlayType = this.getAttribute('data-overlay');

                // Switch main overlay
                switchMainOverlay(overlayType);
            });
        });

        // Add event listeners for indicator tabs
        document.querySelectorAll('#indicatorTabs .nav-link').forEach(tab => {
            tab.addEventListener('click', function(e) {
                e.preventDefault();
                const indicatorTypeParam = this.getAttribute('data-indicator');

                // Switch indicator
                switchIndicator(indicatorTypeParam);
            });
        });

        // Add event listeners for info tabs
        document.querySelectorAll('#infoTabs .nav-link').forEach(tab => {
            tab.addEventListener('click', function(e) {
                e.preventDefault();
                const infoType = this.getAttribute('data-info');

                // Update active tab
                document.querySelectorAll('#infoTabs .nav-link').forEach(t => {
                    t.classList.remove('active');
                });
                this.classList.add('active');

                // Toggle info display
                toggleInfoDisplay(infoType);
            });
        });

        // Add event listeners for buttons
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        if (fullscreenBtn) {
            fullscreenBtn.addEventListener('click', toggleFullscreen);
        }

        const backBtn = document.getElementById('back-btn');
        if (backBtn) {
            backBtn.addEventListener('click', function() {
                window.history.back();
            });
        }

        // Add event listeners for navigation buttons
        const prevBtn = document.getElementById('prev-btn');
        if (prevBtn) {
            prevBtn.addEventListener('click', navigateToPreviousStock);
        }

        const nextBtn = document.getElementById('next-btn');
        if (nextBtn) {
            nextBtn.addEventListener('click', navigateToNextStock);
        }

        // Handle window resize
        window.addEventListener('resize', function() {
            if (chartInstance) chartInstance.resize();
        });

        // Handle mouse wheel for zooming
        document.addEventListener('wheel', function(event) {
            // Only handle wheel events when hovering over the chart
            const chartArea = document.querySelector('.unified-chart-area');
            if (chartArea && chartArea.contains(event.target)) {
                // Prevent default scrolling behavior
                event.preventDefault();

                // Get the current zoom level from the chart instance
                if (chartInstance) {
                    const option = chartInstance.getOption();
                    if (option && option.dataZoom && option.dataZoom.length > 0) {
                        const currentStart = option.dataZoom[0].start || 0;
                        const currentEnd = option.dataZoom[0].end || 100;

                        // Calculate zoom delta (sensitive to wheel movement)
                        const zoomDelta = event.deltaY > 0 ? 5 : -5;

                        // Calculate new zoom levels
                        let newStart = currentStart - zoomDelta;
                        let newEnd = currentEnd + zoomDelta;

                        // Ensure bounds
                        if (newStart < 0) {
                            newStart = 0;
                            newEnd = Math.min(100, newEnd - newStart);
                        }
                        if (newEnd > 100) {
                            newEnd = 100;
                            newStart = Math.max(0, newStart - (newEnd - 100));
                        }

                        // Apply zoom
                        chartInstance.dispatchAction({
                            type: 'dataZoom',
                            start: newStart,
                            end: newEnd
                        });
                    }
                }
            }
        }, { passive: false });
    });
</script>
{% endblock %}

