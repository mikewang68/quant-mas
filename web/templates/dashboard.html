{% extends "base.html" %}

{% block title %}仪表板 - 量化交易系统{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                            <h1 class="mb-0">
                                <i class="fas fa-tachometer-alt"></i> 系统仪表板
                            </h1>
                            <div class="d-flex align-items-center">
                                <label for="accountSelect" class="form-label me-2 mb-0" style="font-size: 1rem;">选择账户:</label>
                                <select class="form-select d-inline-block w-auto" id="accountSelect" style="font-size: 1rem; padding: 0.25rem 0.5rem;">
                                    <option value="">加载中...</option>
                                </select>
                            </div>
                        </div>
                <hr>
            </div>
    </div>

    <!-- Account Overview and Portfolio Performance Chart Section -->
    <div class="row mb-4" id="accountOverviewSection" style="display: none;">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-wallet"></i> 账户总览及历史收益曲线</h5>
                        <div>
                            <label for="benchmarkSelect" class="form-label me-2 mb-0 text-white">对比标的:</label>
                            <select class="form-select d-inline-block w-auto" id="benchmarkSelect">
                                <option value="000016">上证50</option>
                                <option value="000300" selected>沪深300</option>
                                <option value="000905">中证500</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row g-0">
                        <!-- Account Overview List (1/4 width) -->
                        <div class="col-md-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <ul class="list-group">
                                        <li class="list-group-item d-flex justify-content-between align-items-center fs-6">
                                            账户净值
                                            <span class="badge bg-primary rounded-pill fs-6" id="accountNetValue">¥0.00</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center fs-6">
                                            收益率
                                            <span class="badge bg-success rounded-pill fs-6" id="cumulativeReturn">0.00%</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center fs-6">
                                            最大回撤
                                            <span class="badge bg-warning rounded-pill fs-6" id="maxDrawdown">¥0.00</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center fs-6">
                                            夏普比率
                                            <span class="badge bg-info rounded-pill fs-6" id="sharpeRatio">0.00</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center fs-6">
                                            胜率
                                            <span class="badge bg-success rounded-pill fs-6" id="winRate">0.00%</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center fs-6">
                                            盈亏比
                                            <span class="badge bg-info rounded-pill fs-6" id="profitLossRatio">0.00</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center fs-6">
                                            波动率
                                            <span class="badge bg-warning rounded-pill fs-6" id="volatility">0.00%</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center fs-6">
                                            VaR
                                            <span class="badge bg-danger rounded-pill fs-6" id="varValue">¥0.00</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Portfolio Performance Chart (3/4 width) -->
                        <div class="col-md-9">
                            <div class="card h-100">
                                <div class="card-body">
                                    <canvas id="portfolioChart" height="300"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Remove the separate portfolio chart section -->

    <!-- Remove the separate portfolio chart section -->

    <!-- Positions and Risk Monitoring Section -->
    <div class="row mb-4" id="positionsRiskSection" style="display: none;">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <ul class="nav nav-tabs card-header-tabs" id="positionsRiskTabs">
                        <li class="nav-item">
                            <a class="nav-link active" id="positions-tab" data-bs-toggle="tab" href="#positions">持仓信息</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="risk-tab" data-bs-toggle="tab" href="#risk">风险监控</a>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content">
                        <!-- Positions Tab -->
                        <div class="tab-pane fade show active" id="positions">
                            <div class="row">
                                <div class="col-md-12">
                                    <h5><i class="fas fa-chart-pie"></i> 当前持仓</h5>
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover">
                                            <thead>
                                                <tr>
                                                    <th>标的代码</th>
                                                    <th>标的名称</th>
                                                    <th>持仓数量</th>
                                                    <th>当前市值</th>
                                                    <th>持仓盈亏</th>
                                                    <th>持仓天数</th>
                                                    <th>止损/止盈线</th>
                                                </tr>
                                            </thead>
                                            <tbody id="positionsTableBody">
                                                <!-- Positions will be loaded here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <h6>持仓占比</h6>
                                    <div class="progress">
                                        <div class="progress-bar bg-success" role="progressbar" style="width: 0%" id="positionRatio">0%</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6>现金占比</h6>
                                    <div class="progress">
                                        <div class="progress-bar bg-info" role="progressbar" style="width: 0%" id="cashRatio">0%</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Risk Monitoring Tab -->
                        <div class="tab-pane fade" id="risk">
                            <div class="row">
                                <div class="col-md-12">
                                    <h5><i class="fas fa-exclamation-triangle"></i> 风险监控</h5>
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>持仓标的</th>
                                                    <th>波动率</th>
                                                    <th>VaR</th>
                                                    <th>止损/止盈线</th>
                                                    <th>市场风险提示</th>
                                                </tr>
                                            </thead>
                                            <tbody id="riskMonitoringTableBody">
                                                <!-- Risk monitoring data will be loaded here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Trading Records Section -->
    <div class="row mb-4" id="tradingRecordsSection" style="display: none;">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-warning text-white">
                    <ul class="nav nav-tabs card-header-tabs" id="tradingRecordsTabs">
                        <li class="nav-item">
                            <a class="nav-link active" id="recent-trades-tab" data-bs-toggle="tab" href="#recentTrades">最近交易</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="open-trades-tab" data-bs-toggle="tab" href="#openTrades">未结交易</a>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content">
                        <!-- Recent Trades Tab -->
                        <div class="tab-pane fade show active" id="recentTrades">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>交易时间</th>
                                            <th>标的代码</th>
                                            <th>标的名称</th>
                                            <th>交易类型</th>
                                            <th>交易数量</th>
                                            <th>交易价格</th>
                                            <th>交易盈亏</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentTradesTableBody">
                                        <!-- Recent trades will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Open Trades Tab -->
                        <div class="tab-pane fade" id="openTrades">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>标的代码</th>
                                            <th>标的名称</th>
                                            <th>持仓数量</th>
                                            <th>成本价格</th>
                                            <th>当前价格</th>
                                            <th>预期收益/亏损</th>
                                        </tr>
                                    </thead>
                                    <tbody id="openTradesTableBody">
                                        <!-- Open trades will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let portfolioChart = null;

    // Load accounts when page loads
    $(document).ready(function() {
        loadAccounts();
    
            // Set default account to 'wdg' and load its data
            setTimeout(function() {
                const accountSelect = $('#accountSelect');
                const wdgOption = accountSelect.find('option').filter(function() {
                    return $(this).text() === 'wdg';
                });
    
                if (wdgOption.length > 0) {
                    const accountId = wdgOption.val();
                    accountSelect.val(accountId).trigger('change');
                } else if (accountSelect.find('option').length > 1) {
                    // If 'wdg' not found, select the first account (excluding the "请选择账户" option)
                    const firstAccountOption = accountSelect.find('option[value!=""]').first();
                    if (firstAccountOption.length > 0) {
                        firstAccountOption.prop('selected', true);
                        accountSelect.trigger('change');
                    }
                }
            }, 500); // Small delay to ensure accounts are loaded
    });

    // Load all accounts
    function loadAccounts() {
        $.get('/api/accounts')
            .done(function(accounts) {
                const accountSelect = $('#accountSelect');
                accountSelect.empty();

                if (accounts.length === 0) {
                    accountSelect.append('<option value="">暂无账户</option>');
                    return;
                }

                // Add default option
                accountSelect.append('<option value="">请选择账户</option>');

                // Add all accounts
                accounts.forEach(function(account) {
                    const option = $('<option></option>');
                    option.val(account._id);
                    option.text(account.name || '未命名账户');
                    accountSelect.append(option);
                });
            })
            .fail(function(xhr, status, error) {
                console.error('Failed to load accounts:', error);
                $('#accountSelect').html('<option value="">加载失败</option>');
            });
    }

    // Handle account selection change
    $('#accountSelect').change(function() {
        const accountId = $(this).val();
        if (accountId) {
            loadAccountData(accountId);
        } else {
            // Hide all sections if no account selected
            $('#accountOverviewSection').hide();
            $('#portfolioChartSection').hide();
            $('#positionsRiskSection').hide();
            $('#tradingRecordsSection').hide();
        }
    });

    // Load account data
    function loadAccountData(accountId) {
        // Show all sections
        $('#accountOverviewSection').show();
        $('#positionsRiskSection').show();
        $('#tradingRecordsSection').show();

        // Load account overview
        loadAccountOverview(accountId);

        // Load positions
        loadPositions(accountId);

        // Load trading records
        loadTradingRecords(accountId);

        // Load risk monitoring data
        loadRiskMonitoringData(accountId);

        // Load portfolio performance data
        loadPortfolioPerformance(accountId);
    }

    // Load portfolio performance data
    function loadPortfolioPerformance(accountId) {
        $.get(`/api/account-performance/${accountId}`)
            .done(function(performanceData) {
                if (performanceData && performanceData.length > 0) {
                    // Filter data for the last 2 years
                    const twoYearsAgo = new Date();
                    twoYearsAgo.setFullYear(twoYearsAgo.getFullYear() - 2);

                    const filteredData = performanceData.filter(item => {
                        const itemDate = new Date(item.date);
                        return itemDate >= twoYearsAgo;
                    });

                    if (filteredData.length > 0) {
                        // Extract data for chart
                        const dates = filteredData.map(item => item.date);
                        const values = filteredData.map(item => item.total_value);
                        const cashValues = filteredData.map(item => item.cash);

                        // Update chart
                        updatePortfolioChart(dates, values, cashValues);
                    }
                }
            })
            .fail(function(xhr, status, error) {
                console.error('Failed to load portfolio performance data:', error);
            });
    }

    // Update portfolio chart
    function updatePortfolioChart(dates, values, cashValues) {
        const ctx = document.getElementById('portfolioChart').getContext('2d');

        if (portfolioChart) {
            portfolioChart.destroy();
        }

        portfolioChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [
                    {
                        label: '账户总值',
                        data: values,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1,
                        yAxisID: 'y'
                    },
                    {
                        label: '现金余额',
                        data: cashValues,
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.1,
                        yAxisID: 'y'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false,
                        title: {
                            display: true,
                            text: '金额 (¥)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: '日期'
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += '¥' + context.parsed.y.toFixed(2);
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }

    // Load account overview data
    function loadAccountOverview(accountId) {
        $.get(`/api/accounts`)
            .done(function(accounts) {
                const account = accounts.find(acc => acc._id === accountId);
                if (account) {
                    // Calculate account metrics
                    const initialCapital = account.initial_capital || 0;
                    const cash = account.cash || 0;
                    const stocks = account.stocks || [];

                    // Calculate total stock value (using cost price for now, would need real-time prices)
                    let totalStockValue = 0;
                    stocks.forEach(stock => {
                        totalStockValue += (stock.cost || 0) * (stock.quantity || 0);
                    });

                    const totalValue = cash + totalStockValue;
                    const profitAmount = totalValue - initialCapital;
                    const profitRatio = initialCapital !== 0 ? (profitAmount / initialCapital) * 100 : 0;

                    // Update UI
                    $('#accountNetValue').text(`¥${totalValue.toFixed(2)}`);

                    // Set other metrics to default values (would be calculated in real implementation)
                    $('#cumulativeReturn').text(`${profitRatio.toFixed(2)}%`).removeClass('text-success text-danger').addClass(profitRatio >= 0 ? 'text-success' : 'text-danger');
                    $('#maxDrawdown').text('¥0.00');
                    $('#sharpeRatio').text('0.00');
                    $('#winRate').text('0.00%');
                    $('#profitLossRatio').text('0.00');
                    $('#volatility').text('0.00%');
                    $('#varValue').text('¥0.00');
                }
            })
            .fail(function(xhr, status, error) {
                console.error('Failed to load account overview:', error);
            });
    }

    // Load positions data
    function loadPositions(accountId) {
        $.get(`/api/accounts`)
            .done(function(accounts) {
                const account = accounts.find(acc => acc._id === accountId);
                if (account) {
                    const stocks = account.stocks || [];
                    const positionsTableBody = $('#positionsTableBody');
                    positionsTableBody.empty();

                    if (stocks.length === 0) {
                        positionsTableBody.append('<tr><td colspan="7" class="text-center">暂无持仓</td></tr>');
                        return;
                    }

                    // Calculate total value for position ratio
                    const initialCapital = account.initial_capital || 0;
                    const cash = account.cash || 0;
                    let totalStockValue = 0;
                    stocks.forEach(stock => {
                        totalStockValue += (stock.cost || 0) * (stock.quantity || 0);
                    });
                    const totalValue = cash + totalStockValue;

                    stocks.forEach(function(stock) {
                        const marketValue = (stock.cost || 0) * (stock.quantity || 0);
                        const profitAmount = marketValue - ((stock.cost || 0) * (stock.quantity || 0)); // Would need real-time prices
                        const profitRatio = (stock.cost || 0) !== 0 ? (profitAmount / ((stock.cost || 0) * (stock.quantity || 0))) * 100 : 0;

                        const row = `
                            <tr>
                                <td>${stock.code}</td>
                                <td>${stock.name}</td>
                                <td>${stock.quantity}</td>
                                <td>¥${marketValue.toFixed(2)}</td>
                                <td class="${profitAmount >= 0 ? 'text-success' : 'text-danger'}">
                                    ${profitAmount >= 0 ? '+' : ''}${profitAmount.toFixed(2)} (${profitRatio >= 0 ? '+' : ''}${profitRatio.toFixed(2)}%)
                                </td>
                                <td>0</td>
                                <td>¥${(stock.cost * 0.95).toFixed(2)} / ¥${(stock.cost * 1.05).toFixed(2)}</td>
                            </tr>
                        `;
                        positionsTableBody.append(row);
                    });

                    // Update position and cash ratios
                    if (totalValue > 0) {
                        const positionRatio = (totalStockValue / totalValue) * 100;
                        const cashRatio = (cash / totalValue) * 100;
                        $('#positionRatio').css('width', `${positionRatio}%`).text(`${positionRatio.toFixed(1)}%`);
                        $('#cashRatio').css('width', `${cashRatio}%`).text(`${cashRatio.toFixed(1)}%`);
                    }
                }
            })
            .fail(function(xhr, status, error) {
                console.error('Failed to load positions:', error);
                $('#positionsTableBody').html('<tr><td colspan="7" class="text-center text-danger">加载持仓信息失败</td></tr>');
            });
    }

    // Load trading records
    function loadTradingRecords(accountId) {
        $.get('/api/orders')
            .done(function(orders) {
                // Filter orders for this account
                const accountOrders = orders.filter(order => order.account_id === accountId);

                // Recent trades (last 10)
                const recentTrades = accountOrders.slice(0, 10);
                const recentTradesTableBody = $('#recentTradesTableBody');
                recentTradesTableBody.empty();

                if (recentTrades.length === 0) {
                    recentTradesTableBody.append('<tr><td colspan="7" class="text-center">暂无交易记录</td></tr>');
                } else {
                    recentTrades.forEach(function(order) {
                        const row = `
                            <tr>
                                <td>${order.date}</td>
                                <td>${order.code}</td>
                                <td>${order.name}</td>
                                <td class="${order.quantity > 0 ? 'text-success' : 'text-danger'}">${order.quantity > 0 ? '买入' : '卖出'}</td>
                                <td>${Math.abs(order.quantity)}</td>
                                <td>¥${order.price.toFixed(2)}</td>
                                <td class="text-muted">待计算</td>
                            </tr>
                        `;
                        recentTradesTableBody.append(row);
                    });
                }

                // Open trades (would need to calculate from positions)
                const openTradesTableBody = $('#openTradesTableBody');
                openTradesTableBody.empty();
                openTradesTableBody.append('<tr><td colspan="6" class="text-center">暂无未结交易</td></tr>');
            })
            .fail(function(xhr, status, error) {
                console.error('Failed to load trading records:', error);
                $('#recentTradesTableBody').html('<tr><td colspan="7" class="text-center text-danger">加载交易记录失败</td></tr>');
                $('#openTradesTableBody').html('<tr><td colspan="6" class="text-center text-danger">加载未结交易失败</td></tr>');
            });
    }

    // Load risk monitoring data
    function loadRiskMonitoringData(accountId) {
        $.get(`/api/accounts`)
            .done(function(accounts) {
                const account = accounts.find(acc => acc._id === accountId);
                if (account) {
                    const stocks = account.stocks || [];
                    const riskMonitoringTableBody = $('#riskMonitoringTableBody');
                    riskMonitoringTableBody.empty();

                    if (stocks.length === 0) {
                        riskMonitoringTableBody.append('<tr><td colspan="5" class="text-center">暂无持仓</td></tr>');
                        return;
                    }

                    stocks.forEach(function(stock) {
                        const row = `
                            <tr>
                                <td>${stock.code} (${stock.name})</td>
                                <td>0.00%</td>
                                <td>¥0.00</td>
                                <td>¥${(stock.cost * 0.95).toFixed(2)} / ¥${(stock.cost * 1.05).toFixed(2)}</td>
                                <td class="text-warning">无特殊风险提示</td>
                            </tr>
                        `;
                        riskMonitoringTableBody.append(row);
                    });
                }
            })
            .fail(function(xhr, status, error) {
                console.error('Failed to load risk monitoring data:', error);
                $('#riskMonitoringTableBody').html('<tr><td colspan="5" class="text-center text-danger">加载风险监控数据失败</td></tr>');
            });
    }

    // Initialize chart when portfolio chart section is shown
    $('#portfolioChartSection').on('shown.bs.collapse', function() {
        initPortfolioChart();
    });

    // Initialize chart on page load if section is visible
    if ($('#portfolioChartSection').is(':visible')) {
        initPortfolioChart();
    }
</script>
{% endblock %}

