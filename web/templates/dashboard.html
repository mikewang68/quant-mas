{% extends "base.html" %}

{% block title %}仪表板 - 量化交易系统{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                            <h1 class="mb-0">
                                <i class="fas fa-tachometer-alt"></i> 系统仪表板
                            </h1>
                            <div class="d-flex align-items-center">
                                <label for="accountSelect" class="form-label me-2 mb-0" style="font-size: 1rem;">选择账户:</label>
                                <select class="form-select d-inline-block w-auto" id="accountSelect" style="font-size: 1rem; padding: 0.25rem 0.5rem;">
                                    <option value="">加载中...</option>
                                </select>
                            </div>
                        </div>
                <hr>
            </div>
    </div>

    <!-- Account Overview and Portfolio Chart Section -->
        <div class="row mb-4" id="accountOverviewChartSection" style="display: none;">
            <div class="col-md-12">
                    
                    <div class="row">
                        <!-- Account Overview -->
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h6><i class="fas fa-wallet"></i> 账户总览</h6>
                                </div>
                                <div class="card-body">
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>账户净值</span>
                                            <span id="accountNetValue" class="fw-bold">¥0.00</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>净值变化</span>
                                            <span id="accountNetValueChange">+¥0.00 <span id="accountNetValueChangePercent">(+0.00%)</span></span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>累计收益率</span>
                                            <span id="cumulativeReturn" class="fw-bold">0.00%</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>年化收益率</span>
                                            <span id="annualizedReturn">0.00%</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>最大回撤</span>
                                            <span id="maxDrawdown">¥0.00 (<span id="maxDrawdownPercent">0.00%</span>)</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>夏普比率</span>
                                            <span id="sharpeRatio">0.00</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>胜率</span>
                                            <span id="winRate">0.00%</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>盈亏比</span>
                                            <span id="profitLossRatio">0.00</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>波动率</span>
                                            <span id="volatility">0.00%</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>VaR (95%)</span>
                                            <span id="varValue">¥0.00</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
    
                        <!-- Portfolio Performance Chart -->
                        <div class="col-md-8">
                            
                                                <div style="position: relative; height: 400px; overflow: hidden;">
                                                    <canvas id="portfolioChart" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></canvas>
                                                </div>
                        </div>
                    </div>
                </div>
            </div>

    <!-- Positions and Risk Monitoring Section -->
    <div class="row mb-4" id="positionsRiskSection" style="display: none;">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <ul class="nav nav-tabs card-header-tabs" id="positionsRiskTabs">
                        <li class="nav-item">
                            <a class="nav-link active" id="positions-tab" data-bs-toggle="tab" href="#positions">持仓信息</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="risk-tab" data-bs-toggle="tab" href="#risk">风险监控</a>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content">
                        <!-- Positions Tab -->
                        <div class="tab-pane fade show active" id="positions">
                            <div class="row">
                                <div class="col-md-12">
                                    <h5><i class="fas fa-chart-pie"></i> 当前持仓</h5>
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover">
                                            <thead>
                                                <tr>
                                                    <th>标的代码</th>
                                                    <th>标的名称</th>
                                                    <th>持仓数量</th>
                                                    <th>当前市值</th>
                                                    <th>持仓盈亏</th>
                                                    <th>持仓天数</th>
                                                    <th>止损/止盈线</th>
                                                </tr>
                                            </thead>
                                            <tbody id="positionsTableBody">
                                                <!-- Positions will be loaded here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <h6>持仓占比</h6>
                                    <div class="progress">
                                        <div class="progress-bar bg-success" role="progressbar" style="width: 0%" id="positionRatio">0%</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6>现金占比</h6>
                                    <div class="progress">
                                        <div class="progress-bar bg-info" role="progressbar" style="width: 0%" id="cashRatio">0%</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Risk Monitoring Tab -->
                        <div class="tab-pane fade" id="risk">
                            <div class="row">
                                <div class="col-md-12">
                                    <h5><i class="fas fa-exclamation-triangle"></i> 风险监控</h5>
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>持仓标的</th>
                                                    <th>波动率</th>
                                                    <th>VaR</th>
                                                    <th>止损/止盈线</th>
                                                    <th>市场风险提示</th>
                                                </tr>
                                            </thead>
                                            <tbody id="riskMonitoringTableBody">
                                                <!-- Risk monitoring data will be loaded here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Trading Records Section -->
    <div class="row mb-4" id="tradingRecordsSection" style="display: none;">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-warning text-white">
                    <ul class="nav nav-tabs card-header-tabs" id="tradingRecordsTabs">
                        <li class="nav-item">
                            <a class="nav-link active" id="recent-trades-tab" data-bs-toggle="tab" href="#recentTrades">最近交易</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="open-trades-tab" data-bs-toggle="tab" href="#openTrades">未结交易</a>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content">
                        <!-- Recent Trades Tab -->
                        <div class="tab-pane fade show active" id="recentTrades">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>交易时间</th>
                                            <th>标的代码</th>
                                            <th>标的名称</th>
                                            <th>交易类型</th>
                                            <th>交易数量</th>
                                            <th>交易价格</th>
                                            <th>交易盈亏</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentTradesTableBody">
                                        <!-- Recent trades will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Open Trades Tab -->
                        <div class="tab-pane fade" id="openTrades">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>标的代码</th>
                                            <th>标的名称</th>
                                            <th>持仓数量</th>
                                            <th>成本价格</th>
                                            <th>当前价格</th>
                                            <th>预期收益/亏损</th>
                                        </tr>
                                    </thead>
                                    <tbody id="openTradesTableBody">
                                        <!-- Open trades will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let portfolioChart = null;

    // Load accounts when page loads
    $(document).ready(function() {
        loadAccounts();
    
            // Set default account to 'wdg' and load its data
            setTimeout(function() {
                const accountSelect = $('#accountSelect');
                const wdgOption = accountSelect.find('option').filter(function() {
                    return $(this).text() === 'wdg';
                });
    
                if (wdgOption.length > 0) {
                    const accountId = wdgOption.val();
                    accountSelect.val(accountId).trigger('change');
                } else if (accountSelect.find('option').length > 1) {
                    // If 'wdg' not found, select the first account (excluding the "请选择账户" option)
                    const firstAccountOption = accountSelect.find('option[value!=""]').first();
                    if (firstAccountOption.length > 0) {
                        firstAccountOption.prop('selected', true);
                        accountSelect.trigger('change');
                    }
                }
            }, 500); // Small delay to ensure accounts are loaded
    });

    // Load all accounts
    function loadAccounts() {
        $.get('/api/accounts')
            .done(function(accounts) {
                const accountSelect = $('#accountSelect');
                accountSelect.empty();

                if (accounts.length === 0) {
                    accountSelect.append('<option value="">暂无账户</option>');
                    return;
                }

                // Add default option
                accountSelect.append('<option value="">请选择账户</option>');

                // Add all accounts
                accounts.forEach(function(account) {
                    const option = $('<option></option>');
                    option.val(account._id);
                    option.text(account.name || '未命名账户');
                    accountSelect.append(option);
                });
            })
            .fail(function(xhr, status, error) {
                console.error('Failed to load accounts:', error);
                $('#accountSelect').html('<option value="">加载失败</option>');
            });
    }

    // Handle account selection change
    $('#accountSelect').change(function() {
        const accountId = $(this).val();
        if (accountId) {
            loadAccountData(accountId);
        } else {
            // Hide all sections if no account selected
            $('#accountOverviewSection').hide();
            $('#portfolioChartSection').hide();
            $('#positionsRiskSection').hide();
            $('#tradingRecordsSection').hide();
        }
    });

    // Load account data
    function loadAccountData(accountId) {
        // Show all sections
            $('#accountOverviewChartSection').show();
        $('#positionsRiskSection').show();
        $('#tradingRecordsSection').show();

        // Load account overview
        loadAccountOverview(accountId);

        // Load positions
        loadPositions(accountId);

        // Load trading records
        loadTradingRecords(accountId);

        // Load risk monitoring data
        loadRiskMonitoringData(accountId);
    
            // Initialize portfolio chart
            initPortfolioChart(accountId);
    }

    // Load account overview data
    function loadAccountOverview(accountId) {
        $.get(`/api/accounts`)
            .done(function(accounts) {
                const account = accounts.find(acc => acc._id === accountId);
                if (account) {
                    // Calculate account metrics
                    const initialCapital = account.initial_capital || 0;
                    const cash = account.cash || 0;
                    const stocks = account.stocks || [];

                    // Calculate total stock value (using cost price for now, would need real-time prices)
                    let totalStockValue = 0;
                    stocks.forEach(stock => {
                        totalStockValue += (stock.cost || 0) * (stock.quantity || 0);
                    });

                    const totalValue = cash + totalStockValue;
                    const profitAmount = totalValue - initialCapital;
                    const profitRatio = initialCapital !== 0 ? (profitAmount / initialCapital) * 100 : 0;

                    // Update UI
                    $('#accountNetValue').text(`¥${totalValue.toFixed(2)}`);
                    $('#accountNetValueChange').html(`${profitAmount >= 0 ? '+' : ''}${profitAmount.toFixed(2)} <span id="accountNetValueChangePercent">(${profitRatio >= 0 ? '+' : ''}${profitRatio.toFixed(2)}%)</span>`);
                    $('#accountNetValueChangePercent').removeClass('text-success text-danger').addClass(profitAmount >= 0 ? 'text-success' : 'text-danger');

                    // Set other metrics to default values (would be calculated in real implementation)
                    $('#cumulativeReturn').text(`${profitRatio.toFixed(2)}%`).removeClass('text-success text-danger').addClass(profitRatio >= 0 ? 'text-success' : 'text-danger');
                    $('#annualizedReturn').text(`年化: ${(profitRatio * 12).toFixed(2)}%`);
                    $('#maxDrawdown').text('¥0.00');
                    $('#maxDrawdownPercent').text('0.00%');
                    $('#sharpeRatio').text('0.00');
                    $('#winRate').text('0.00%');
                    $('#profitLossRatio').text('0.00');
                    $('#volatility').text('0.00%');
                    $('#varValue').text('¥0.00');
                }
            })
            .fail(function(xhr, status, error) {
                console.error('Failed to load account overview:', error);
            });
    }

    // Load positions data
    function loadPositions(accountId) {
        $.get(`/api/accounts`)
            .done(function(accounts) {
                const account = accounts.find(acc => acc._id === accountId);
                if (account) {
                    const stocks = account.stocks || [];
                    const positionsTableBody = $('#positionsTableBody');
                    positionsTableBody.empty();

                    if (stocks.length === 0) {
                        positionsTableBody.append('<tr><td colspan="7" class="text-center">暂无持仓</td></tr>');
                        return;
                    }

                    // Calculate total value for position ratio
                    const initialCapital = account.initial_capital || 0;
                    const cash = account.cash || 0;
                    let totalStockValue = 0;
                    stocks.forEach(stock => {
                        totalStockValue += (stock.cost || 0) * (stock.quantity || 0);
                    });
                    const totalValue = cash + totalStockValue;

                    stocks.forEach(function(stock) {
                        const marketValue = (stock.cost || 0) * (stock.quantity || 0);
                        const profitAmount = marketValue - ((stock.cost || 0) * (stock.quantity || 0)); // Would need real-time prices
                        const profitRatio = (stock.cost || 0) !== 0 ? (profitAmount / ((stock.cost || 0) * (stock.quantity || 0))) * 100 : 0;

                        const row = `
                            <tr>
                                <td>${stock.code}</td>
                                <td>${stock.name}</td>
                                <td>${stock.quantity}</td>
                                <td>¥${marketValue.toFixed(2)}</td>
                                <td class="${profitAmount >= 0 ? 'text-success' : 'text-danger'}">
                                    ${profitAmount >= 0 ? '+' : ''}${profitAmount.toFixed(2)} (${profitRatio >= 0 ? '+' : ''}${profitRatio.toFixed(2)}%)
                                </td>
                                <td>0</td>
                                <td>¥${(stock.cost * 0.95).toFixed(2)} / ¥${(stock.cost * 1.05).toFixed(2)}</td>
                            </tr>
                        `;
                        positionsTableBody.append(row);
                    });

                    // Update position and cash ratios
                    if (totalValue > 0) {
                        const positionRatio = (totalStockValue / totalValue) * 100;
                        const cashRatio = (cash / totalValue) * 100;
                        $('#positionRatio').css('width', `${positionRatio}%`).text(`${positionRatio.toFixed(1)}%`);
                        $('#cashRatio').css('width', `${cashRatio}%`).text(`${cashRatio.toFixed(1)}%`);
                    }
                }
            })
            .fail(function(xhr, status, error) {
                console.error('Failed to load positions:', error);
                $('#positionsTableBody').html('<tr><td colspan="7" class="text-center text-danger">加载持仓信息失败</td></tr>');
            });
    }

    // Load trading records
    function loadTradingRecords(accountId) {
        $.get('/api/orders')
            .done(function(orders) {
                // Filter orders for this account
                const accountOrders = orders.filter(order => order.account_id === accountId);

                // Recent trades (last 10)
                const recentTrades = accountOrders.slice(0, 10);
                const recentTradesTableBody = $('#recentTradesTableBody');
                recentTradesTableBody.empty();

                if (recentTrades.length === 0) {
                    recentTradesTableBody.append('<tr><td colspan="7" class="text-center">暂无交易记录</td></tr>');
                } else {
                    recentTrades.forEach(function(order) {
                        const row = `
                            <tr>
                                <td>${order.date}</td>
                                <td>${order.code}</td>
                                <td>${order.name}</td>
                                <td class="${order.quantity > 0 ? 'text-success' : 'text-danger'}">${order.quantity > 0 ? '买入' : '卖出'}</td>
                                <td>${Math.abs(order.quantity)}</td>
                                <td>¥${order.price.toFixed(2)}</td>
                                <td class="text-muted">待计算</td>
                            </tr>
                        `;
                        recentTradesTableBody.append(row);
                    });
                }

                // Open trades (would need to calculate from positions)
                const openTradesTableBody = $('#openTradesTableBody');
                openTradesTableBody.empty();
                openTradesTableBody.append('<tr><td colspan="6" class="text-center">暂无未结交易</td></tr>');
            })
            .fail(function(xhr, status, error) {
                console.error('Failed to load trading records:', error);
                $('#recentTradesTableBody').html('<tr><td colspan="7" class="text-center text-danger">加载交易记录失败</td></tr>');
                $('#openTradesTableBody').html('<tr><td colspan="6" class="text-center text-danger">加载未结交易失败</td></tr>');
            });
    }

    // Load risk monitoring data
    function loadRiskMonitoringData(accountId) {
        $.get(`/api/accounts`)
            .done(function(accounts) {
                const account = accounts.find(acc => acc._id === accountId);
                if (account) {
                    const stocks = account.stocks || [];
                    const riskMonitoringTableBody = $('#riskMonitoringTableBody');
                    riskMonitoringTableBody.empty();

                    if (stocks.length === 0) {
                        riskMonitoringTableBody.append('<tr><td colspan="5" class="text-center">暂无持仓</td></tr>');
                        return;
                    }

                    stocks.forEach(function(stock) {
                        const row = `
                            <tr>
                                <td>${stock.code} (${stock.name})</td>
                                <td>0.00%</td>
                                <td>¥0.00</td>
                                <td>¥${(stock.cost * 0.95).toFixed(2)} / ¥${(stock.cost * 1.05).toFixed(2)}</td>
                                <td class="text-warning">无特殊风险提示</td>
                            </tr>
                        `;
                        riskMonitoringTableBody.append(row);
                    });
                }
            })
            .fail(function(xhr, status, error) {
                console.error('Failed to load risk monitoring data:', error);
                $('#riskMonitoringTableBody').html('<tr><td colspan="5" class="text-center text-danger">加载风险监控数据失败</td></tr>');
            });
    }

    // Initialize portfolio chart with 2-year data and benchmark comparison
        function initPortfolioChart(accountId) {
            const ctx = document.getElementById('portfolioChart').getContext('2d');
            if (portfolioChart) {
                portfolioChart.destroy();
            }
    
                // Fetch real account performance data
                $.get(`/api/account-performance/${accountId}`)
                    .done(function(accountData) {
                        // Fetch benchmark index data
                        fetchBenchmarkData(accountId, accountData);
                    })
                    .fail(function(xhr, status, error) {
                        console.error('Failed to load account performance data:', error);
                        // Fallback to mock data if real data fails
                        initChartWithMockData();
                    });
            }

            // Fetch benchmark index data
            function fetchBenchmarkData(accountId, accountData) {
                // Fetch real index data for comparison
                Promise.all([
                    $.get('/api/index-performance/sz399300'), // 沪深300
                    $.get('/api/index-performance/sh000016'), // 上证50
                    $.get('/api/index-performance/sh000905')  // 中证500
                ]).then(function(results) {
                    const hs300Data = results[0];
                    const sz50Data = results[1];
                    const zz500Data = results[2];
    
                    // Process the data for charting
                    renderPortfolioChartWithRealData(accountData, hs300Data, sz50Data, zz500Data);
                }).catch(function(error) {
                    console.error('Failed to load index data:', error);
                    // Fallback to mock data if real index data fails
                    fetchBenchmarkDataFallback(accountData);
                });
            }
    
            // Fallback to generate mock benchmark data
            function fetchBenchmarkDataFallback(accountData) {
                const performanceData = accountData.performance_data || [];
                const months = performanceData.map(item => item.date);
                const portfolioData = performanceData.map(item => item.portfolio_value);
    
                // Generate mock benchmark data that follows a similar pattern to the portfolio
                const hs300Data = generateBenchmarkData(portfolioData, 0.9, 1.1);
                const sz50Data = generateBenchmarkData(portfolioData, 0.85, 1.15);
                const zz500Data = generateBenchmarkData(portfolioData, 0.8, 1.2);
    
                renderPortfolioChart(months, portfolioData, hs300Data, sz50Data, zz500Data);
            }
    
            // Generate benchmark data that follows a similar pattern to portfolio data
            function generateBenchmarkData(portfolioData, minFactor, maxFactor) {
                if (portfolioData.length === 0) return [];
    
                const benchmarkData = [portfolioData[0]]; // Start with the same initial value
                for (let i = 1; i < portfolioData.length; i++) {
                    // Generate a random factor within the specified range
                    const factor = minFactor + Math.random() * (maxFactor - minFactor);
                    // Apply the factor to the previous value to maintain continuity
                    benchmarkData.push(benchmarkData[i-1] * factor);
                }
                return benchmarkData;
            }
    
            // Render the portfolio chart with real data
            function renderPortfolioChartWithRealData(accountData, hs300Data, sz50Data, zz500Data) {
                const performanceData = accountData.performance_data || [];
                const dates = performanceData.map(item => item.date);
                const portfolioValues = performanceData.map(item => item.portfolio_value);
    
                // Process index data to match the date range of portfolio data
                const hs300Values = processIndexData(hs300Data.performance_data, dates, portfolioValues[0]);
                const sz50Values = processIndexData(sz50Data.performance_data, dates, portfolioValues[0]);
                const zz500Values = processIndexData(zz500Data.performance_data, dates, portfolioValues[0]);
    
                renderPortfolioChart(dates, portfolioValues, hs300Values, sz50Values, zz500Values);
            }
    
            // Process index data to match portfolio date range and normalize values
            function processIndexData(indexData, portfolioDates, baseValue) {
                if (!indexData || indexData.length === 0) return [];

                // Create a map of date to closing price for the index
                const indexMap = {};
                indexData.forEach(item => {
                    indexMap[item.date] = item.close;
                });

                // Map portfolio dates to index values (use actual index values, not normalized)
                const result = [];
                let lastKnownValue = null;

                portfolioDates.forEach(date => {
                    const indexValue = indexMap[date];
                    if (indexValue !== undefined) {
                        lastKnownValue = indexValue;
                        result.push(lastKnownValue);
                    } else if (lastKnownValue !== null) {
                        // Use last known value for missing dates
                        result.push(lastKnownValue);
                    } else {
                        // If no previous value, push null
                        result.push(null);
                    }
                });

                return result;
            }
    
            // Render the portfolio chart with real data
            function renderPortfolioChart(months, portfolioData, hs300Data, sz50Data, zz500Data) {
                const ctx = document.getElementById('portfolioChart').getContext('2d');
                if (portfolioChart) {
                    portfolioChart.destroy();
                }

                portfolioChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [
                            {
                                label: '沪深300',
                                data: hs300Data,
                                borderColor: 'rgb(255, 99, 132)',
                                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                fill: false,
                                tension: 0.1,
                                pointRadius: 0,
                                yAxisID: 'y'
                            },
                            {
                                label: '上证50',
                                data: sz50Data,
                                borderColor: 'rgb(54, 162, 235)',
                                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                                borderWidth: 2,
                                borderDash: [10, 5],
                                fill: false,
                                tension: 0.1,
                                pointRadius: 0,
                                yAxisID: 'y'
                            },
                            {
                                label: '中证500',
                                data: zz500Data,
                                borderColor: 'rgb(255, 205, 86)',
                                backgroundColor: 'rgba(255, 205, 86, 0.1)',
                                borderWidth: 2,
                                borderDash: [3, 3],
                                fill: false,
                                tension: 0.1,
                                pointRadius: 0,
                                yAxisID: 'y'
                            },
                            {
                                label: '账户净值',
                                data: portfolioData,
                                borderColor: 'rgb(75, 192, 192)',
                                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.1,
                                pointRadius: 0,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                position: 'left',
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: '指数'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return value.toLocaleString();
                                    }
                                }
                            },
                            y1: {
                                position: 'right',
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: '资产净值'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return '¥' + value.toLocaleString();
                                    }
                                },
                                grid: {
                                    drawOnChartArea: false, // only want the grid lines for one axis to show up
                                }
                            },
                            x: {
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        if (context.dataset.yAxisID === 'y1') {
                                            return context.dataset.label + ': ¥' + context.parsed.y.toLocaleString(undefined, {
                                                minimumFractionDigits: 2,
                                                maximumFractionDigits: 2
                                            });
                                        } else {
                                            return context.dataset.label + ': ' + context.parsed.y.toLocaleString(undefined, {
                                                minimumFractionDigits: 2,
                                                maximumFractionDigits: 2
                                            });
                                        }
                                    }
                                }
                            },
                            legend: {
                                position: 'top',
                            }
                        },
                        // Add padding to prevent data from going outside the canvas
                        layout: {
                            padding: {
                                top: 20,
                                right: 20,
                                bottom: 20,
                                left: 20
                            }
                        },
                        // Ensure chart stays within bounds
                        clip: {
                            left: 10,
                            right: 10,
                            top: 10,
                            bottom: 10
                        }
                    }
                });
            }
    }

    // Initialize chart when account overview/chart section is shown
        $('#accountOverviewChartSection').on('shown.bs.collapse', function() {
            const accountId = $('#accountSelect').val();
            if (accountId) {
                initPortfolioChart(accountId);
            }
        });
    
            // Initialize chart on page load if section is visible
            if ($('#accountOverviewChartSection').is(':visible')) {
                const accountId = $('#accountSelect').val();
                if (accountId) {
                    initPortfolioChart(accountId);
                }
                    }
            
                    // Fallback function to initialize chart with mock data
                    function initChartWithMockData() {
                        const ctx = document.getElementById('portfolioChart').getContext('2d');
                        if (portfolioChart) {
                            portfolioChart.destroy();
                        }
            
                        // Generate 2-year monthly data (24 months)
                        const months = [];
                        const portfolioData = [];
                        const hs300Data = [];
                        const sz50Data = [];
                        const zz500Data = [];
            
                        // Generate date labels for the last 24 months
                        const now = new Date();
                        for (let i = 23; i >= 0; i--) {
                            const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                            months.push(date.toLocaleDateString('zh-CN', { year: 'numeric', month: 'short' }));
            
                            // Generate mock data for portfolio and benchmarks
                            const baseValue = 1000000;
                            const portfolioGrowth = 1 + (Math.random() * 0.3 - 0.1); // -10% to +20%
                            const hs300Growth = 1 + (Math.random() * 0.25 - 0.05); // -5% to +20%
                            const sz50Growth = 1 + (Math.random() * 0.2 - 0.02); // -2% to +18%
                            const zz500Growth = 1 + (Math.random() * 0.35 - 0.15); // -15% to +20%
            
                            portfolioData.push(baseValue * Math.pow(portfolioGrowth, 23 - i));
                            hs300Data.push(baseValue * Math.pow(hs300Growth, 23 - i));
                            sz50Data.push(baseValue * Math.pow(sz50Growth, 23 - i));
                            zz500Data.push(baseValue * Math.pow(zz500Growth, 23 - i));
                        }
            
                        portfolioChart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: months,
                                datasets: [
                                    {
                                        label: '账户净值',
                                        data: portfolioData,
                                        borderColor: 'rgb(75, 192, 192)',
                                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                                        borderWidth: 2,
                                        fill: false,
                                        tension: 0.1,
                                        pointRadius: 0
                                    },
                                    {
                                        label: '沪深300',
                                        data: hs300Data,
                                        borderColor: 'rgb(255, 99, 132)',
                                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                        borderWidth: 2,
                                        borderDash: [5, 5],
                                        fill: false,
                                        tension: 0.1,
                                        pointRadius: 0
                                    },
                                    {
                                        label: '上证50',
                                        data: sz50Data,
                                        borderColor: 'rgb(54, 162, 235)',
                                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                                        borderWidth: 2,
                                        borderDash: [10, 5],
                                        fill: false,
                                        tension: 0.1,
                                        pointRadius: 0
                                    },
                                    {
                                        label: '中证500',
                                        data: zz500Data,
                                        borderColor: 'rgb(255, 205, 86)',
                                        backgroundColor: 'rgba(255, 205, 86, 0.1)',
                                        borderWidth: 2,
                                        borderDash: [3, 3],
                                        fill: false,
                                        tension: 0.1,
                                        pointRadius: 0
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        beginAtZero: false,
                                        ticks: {
                                            callback: function(value) {
                                                return '¥' + value.toLocaleString();
                                            }
                                        }
                                    },
                                    x: {
                                        ticks: {
                                            maxRotation: 45,
                                            minRotation: 45
                                        }
                                    }
                                },
                                plugins: {
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                return context.dataset.label + ': ¥' + context.parsed.y.toLocaleString(undefined, {
                                                    minimumFractionDigits: 2,
                                                    maximumFractionDigits: 2
                                                });
                                            }
                                        }
                                    },
                                    legend: {
                                        position: 'top',
                                    }
                                },
                                // Add padding to prevent data from going outside the canvas
                                layout: {
                                    padding: {
                                        top: 20,
                                        right: 20,
                                        bottom: 20,
                                        left: 20
                                    }
                                },
                                // Ensure chart stays within bounds
                                clip: {
                                    left: 10,
                                    right: 10,
                                    top: 10,
                                    bottom: 10
                                }
                            }
                        });
                    }
                }
</script>
{% endblock %}

