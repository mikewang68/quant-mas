# down2mongo.py 程序文档

## 概述

`down2mongo.py` 是一个用于从 AkShare 获取股票数据并存储到 MongoDB 数据库的程序。该程序主要负责下载股票的 K 线数据，包括不复权、后复权和前复权三种调整方式的数据。

## 功能特性

1. **MongoDB 连接管理**：
   - 通过 `config.mongodb_config` 模块获取数据库配置
   - 建立与 MongoDB 数据库的连接

2. **股票代码更新**：
   - 从 AkShare 获取最新的 A 股股票代码和名称
   - 将股票代码信息存储到 `code` 集合中

3. **增量数据更新**：
   - 根据 `code` 集合中的 `last_updated` 字段判断哪些股票需要更新
   - 只下载需要更新的股票数据，避免重复下载

4. **交易日判断**：
   - 使用 `ak.tool_trade_date_hist_sina()` 获取交易日历
   - 比较当前日期与上次更新日期之间是否有交易日
   - 仅在有交易日时才执行数据下载操作

5. **多类型数据下载**：
   - 下载不复权（normal）数据
   - 下载后复权（hfq）数据
   - 下载前复权（qfq）数据
   - 将三种类型的数据合并存储

6. **IP 限制处理**：
   - 集成路由器控制功能，当遇到访问限制时自动切换 IP
   - 检测 HTTP 错误码（429, 403等）和网络错误
   - 记录已使用的 IP 地址，避免重复使用

7. **缺失数据检查**：
   - 在程序结束前检查是否有股票数据未下载
   - 自动下载缺失的数据
   - 确保所有股票数据完整后才结束程序

8. **数据存储**：
   - 将股票数据存储到 `k_data` 集合中
   - 更新 `code` 集合中的 `last_updated` 字段

## 主要函数说明

### `conn_mongo()`
连接到 MongoDB 数据库，使用项目配置文件中的数据库设置。

### `update_code_name(db)`
从 AkShare 获取最新的股票代码和名称，并更新到 `code` 集合中。

### `get_code_name(db)`
从 `code` 集合中获取所有股票代码和名称。

### `get_stocks_to_update(db, force_update_missing=False)`
获取需要更新的股票代码列表，条件是 `last_updated` 字段小于或等于最新日期，或是空的股票集合。
- `force_update_missing` 参数用于强制更新缺失数据

### `get_lastest_date()`
获取最新的更新日期，当前实现返回当前日期。

### `get_db_lastest_date(db)`
获取数据库中存储的上次更新时间。

### `should_update_data(db)`
判断是否需要更新数据：
- 使用 `ak.tool_trade_date_hist_sina()` 获取交易日历
- 如果当前日期与 update_date 数据集中的 lastest 日期之间有交易日，则返回 True，否则返回 False

### `set_lastest_date(db)`
设置本次更新时间到 `update_date` 集合中。

### `write_k_daily(db)`
下载并存储股票的 K 线数据，是程序的核心函数：
- 获取需要更新的股票列表
- 逐个下载股票数据
- 处理 IP 限制问题
- 存储数据到数据库
- 更新股票的 `last_updated` 字段

### `check_and_download_missing_data(db)`
检查并下载缺失的数据：
- 在程序结束前检查是否所有股票数据都已下载
- 如果有缺失数据则下载
- 确保所有股票数据都下载完成后再结束程序

### `retry_failed_codes(db, failed_codes)`
重新尝试下载失败的股票代码数据。

### `find_missing_k_data(db)`
检查 `code` 表中的代码，在 `k_data` 中没有数据的代码，返回缺失代码的列表。

### `get_k_data_by_code(db, code)`
从 `k_data` 数据集中提取指定代码的股票数据。

### `main()`
程序主入口，按顺序执行各功能函数：
1. 连接数据库
2. 更新股票代码表
3. 判断是否需要更新数据（基于交易日历）
4. 如果需要更新，下载股票数据
5. 检查并下载缺失数据
6. 更新最后更新时间

## 数据结构

### `code` 集合
存储股票代码和名称信息：
- `_id`: 股票代码
- `code`: 股票代码
- `name`: 股票名称
- `last_updated`: 最后更新日期

### `k_data` 集合
存储股票 K 线数据：
- `_id`: 日期+代码组合（如 "2023-01-01:000001"）
- `日期`: 交易日期
- `代码`: 股票代码
- 各种价格、成交量等字段（区分不复权、后复权、前复权）

### `update_date` 集合
存储更新时间信息：
- `lastest`: 最新更新日期

## IP 限制处理机制

程序集成了智能 IP 限制处理机制：
1. 监控 HTTP 错误（429, 403等）和网络错误
2. 当检测到错误时，自动调用路由器控制模块切换 IP
3. 记录已使用的 IP 地址，避免重复使用同一 IP
4. IP 切换后继续数据下载任务

## 使用方法

直接运行程序：
```bash
python utils/down2mongo.py
```

程序将自动完成以下步骤：
1. 连接数据库
2. 更新股票代码表
3. 根据交易日历判断是否需要更新数据
4. 如果需要更新，下载股票数据
5. 检查并下载缺失数据
6. 更新最后更新时间

## 注意事项

1. 确保 MongoDB 数据库配置正确
2. 确保网络连接正常
3. 如需使用 IP 切换功能，需要正确配置路由器控制模块
4. 程序运行时间较长，取决于需要下载的股票数量
5. 程序只在交易日才会执行数据下载操作

