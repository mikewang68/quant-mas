<!DOCTYPE html>
<html>
<head>
    <title>WebRTC IP Detection for ident.me</title>
    <meta charset="utf-8">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        #status {
            margin: 15px 0;
            padding: 15px;
            background: #e9ecef;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }
        .ip-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .ip-section h2 {
            margin-top: 0;
            color: #555;
        }
        #webrtc-ips {
            min-height: 20px;
        }
        .ip-item {
            display: inline-block;
            margin: 5px;
            padding: 8px 12px;
            background: #007bff;
            color: white;
            border-radius: 20px;
            font-family: monospace;
        }
        .info {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 5px 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“¡ WebRTC IPåœ°å€æ£€æµ‹å·¥å…·</h1>

        <div class="info">
            <strong>è¯´æ˜ï¼š</strong>æ­¤å·¥å…·ä½¿ç”¨WebRTCæŠ€æœ¯æ£€æµ‹æ‚¨çš„çœŸå®å…¬ç½‘IPåœ°å€ã€‚
            ä¸HTTPè¯·æ±‚ä¸åŒï¼ŒWebRTCå¯ä»¥ç›´æ¥å‘ç°æ‚¨çš„çœŸå®å®¢æˆ·ç«¯IPåœ°å€ã€‚
        </div>

        <div id="status">æ­£åœ¨æ£€æµ‹IPåœ°å€...</div>

        <div class="ip-section">
            <h2>ğŸŒ WebRTCæ£€æµ‹åˆ°çš„IPåœ°å€</h2>
            <div id="webrtc-ips">
                <p>ç­‰å¾…æ£€æµ‹...</p>
            </div>
        </div>

        <div class="ip-section">
            <h2>ğŸ“‹ è¯¦ç»†æ—¥å¿—</h2>
            <div id="logs" style="font-family: monospace; background: #f8f9fa; padding: 10px; border-radius: 5px; max-height: 200px; overflow-y: auto;">
                <p>ç­‰å¾…æ£€æµ‹å¼€å§‹...</p>
            </div>
        </div>
    </div>

    <script>
        // å­˜å‚¨æ£€æµ‹åˆ°çš„IPåœ°å€
        let detectedIPs = new Set();

        // æ·»åŠ æ—¥å¿—
        function addLog(message) {
            const logsDiv = document.getElementById('logs');
            const time = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<strong>[${time}]</strong> ${message}`;
            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        // æ·»åŠ IPåœ°å€åˆ°æ˜¾ç¤ºåŒºåŸŸ
        function addIP(ip) {
            // éªŒè¯IPæ˜¯å¦å·²å­˜åœ¨
            if (detectedIPs.has(ip)) return;

            // æ·»åŠ åˆ°é›†åˆä¸­
            detectedIPs.add(ip);

            // åˆ›å»ºIPæ ‡ç­¾
            const ipContainer = document.getElementById('webrtc-ips');
            const ipItem = document.createElement('div');
            ipItem.className = 'ip-item';
            ipItem.textContent = ip;

            // å¦‚æœæ˜¯é»˜è®¤æç¤ºæ–‡æœ¬ï¼Œæ¸…ç©ºå®¹å™¨
            if (ipContainer.querySelector('p')) {
                ipContainer.innerHTML = '';
            }

            ipContainer.appendChild(ipItem);

            addLog(`å‘ç°WebRTC IP: ${ip}`);
        }

        // åˆ¤æ–­æ˜¯å¦ä¸ºç§æœ‰IP
        function isPrivateIP(ip) {
            return ip.startsWith('192.168.') ||
                   ip.startsWith('10.') ||
                   (ip.startsWith('172.') &&
                    parseInt(ip.split('.')[1]) >= 16 &&
                    parseInt(ip.split('.')[1]) <= 31);
        }

        // ä¸»è¦çš„IPæ£€æµ‹å‡½æ•°
        function getWebRTCIPs() {
            return new Promise((resolve, reject) => {
                addLog('å¼€å§‹åˆå§‹åŒ–RTCPeerConnection...');

                // åˆ›å»ºRTCPeerConnectionå®ä¾‹
                let pc;
                try {
                    pc = new RTCPeerConnection({
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' },
                            { urls: 'stun:stun.stunprotocol.org:3478' }
                        ]
                    });
                } catch (e) {
                    addLog('é”™è¯¯: æ— æ³•åˆ›å»ºRTCPeerConnection - ' + e.message);
                    reject(e);
                    return;
                }

                // ç›‘å¬ICEå€™é€‰äº‹ä»¶
                pc.onicecandidate = function(ice) {
                    if (!ice || !ice.candidate || !ice.candidate.candidate) return;

                    const candidate = ice.candidate.candidate;
                    addLog('æ”¶åˆ°ICEå€™é€‰: ' + candidate);

                    // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æå–IPåœ°å€
                    const ipRegex = /([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/;
                    const ipMatch = ipRegex.exec(candidate);

                    if (ipMatch && ipMatch[1]) {
                        const ip = ipMatch[1];

                        // è¿‡æ»¤æ— æ•ˆIP
                        if (ip === '0.0.0.0' || ip.startsWith('127.') || ip === '255.255.255.255') {
                            return;
                        }

                        // æ·»åŠ å…¬ç½‘IPåœ°å€ï¼ˆæ’é™¤ç§æœ‰IPï¼‰
                        if (!isPrivateIP(ip)) {
                            addIP(ip);
                        }
                    }
                };

                // åˆ›å»ºæ•°æ®é€šé“
                try {
                    pc.createDataChannel('');

                    // åˆ›å»ºoffer
                    pc.createOffer()
                        .then(offer => {
                            addLog('åˆ›å»ºofferæˆåŠŸ');
                            return pc.setLocalDescription(offer);
                        })
                        .then(() => {
                            addLog('è®¾ç½®æœ¬åœ°æè¿°æˆåŠŸ');
                            // ç»™ä¸€äº›æ—¶é—´æ”¶é›†ICEå€™é€‰
                            setTimeout(() => {
                                addLog('IPæ£€æµ‹å®Œæˆ');
                                resolve();
                            }, 5000);
                        })
                        .catch(err => {
                            addLog('é”™è¯¯: ' + err.message);
                            reject(err);
                        });
                } catch (e) {
                    addLog('é”™è¯¯: åˆ›å»ºæ•°æ®é€šé“å¤±è´¥ - ' + e.message);
                    reject(e);
                }
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨å¼€å§‹æ£€æµ‹
        window.addEventListener('load', async function() {
            const statusDiv = document.getElementById('status');

            try {
                addLog('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹IPåœ°å€æ£€æµ‹');
                statusDiv.textContent = 'æ­£åœ¨æ£€æµ‹IPåœ°å€ï¼Œè¯·ç¨å€™...';

                await getWebRTCIPs();

                // æ£€æµ‹å®Œæˆ
                if (detectedIPs.size > 0) {
                    statusDiv.textContent = 'âœ… IPåœ°å€æ£€æµ‹å®Œæˆ!';
                    statusDiv.style.background = '#d4edda';
                    statusDiv.style.color = '#155724';
                    addLog(`æ£€æµ‹å®Œæˆ: å‘ç° ${detectedIPs.size} ä¸ªå…¬ç½‘IPåœ°å€`);
                } else {
                    statusDiv.textContent = 'âš ï¸ æœªæ£€æµ‹åˆ°å…¬ç½‘IPåœ°å€';
                    statusDiv.style.background = '#fff3cd';
                    statusDiv.style.color = '#856404';
                    addLog('æ£€æµ‹å®Œæˆ: æœªå‘ç°å…¬ç½‘IPåœ°å€');
                }

            } catch (error) {
                statusDiv.textContent = 'âŒ æ£€æµ‹è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯';
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.color = '#721c24';
                addLog('æ£€æµ‹å¤±è´¥: ' + error.message);
            }
        });
    </script>
</body>
</html>

